{% load static %}
{% load catalog_extras %}
<section class="teacher-info">
    <div class="teacher-card" >
      <div class="photo-container">
        <div class="teacher-photo">
          <!-- If a teacher photo is available, display it; otherwise use a default image. -->
          <img :src="item.teacher.photo || '{% static 'images/default-avatar.jpg' %}'" alt="Teacher photo">
        </div>
      </div>
      <div class="teacher-details">
        <!-- Display teacher credentials such as name, position, and department. -->
        <h2>
          <a 
            :href="`{% url 'profile_detail' 0 %}`.replace('0', item.teacher.id)"
            x-text="`${item.teacher.teacher_id.full_name}`"
            class="supervisor-name"
          ></a>
        </h2>
        <template x-if="item.teacher.academic_level">
          <p x-text="`${item.teacher.academic_level}`" class="supervisor-position"></p>
        </template>
        <template x-if="item.teacher.academic_level === null">
          <p>Викладач</p>
        </template>  
        <h3 x-html="`<strong>Кафедра </strong>${item.teacher.teacher_id.department}`" class="supervisor-department"></h3>

        <!-- Conditional logic for displaying the number of free slots. -->
        <div class="slots-container" x-show="item.is_matched || !item.is_matched">
          <!-- No slots -->
          <div class="slots-info no-slots" x-show="item.free_slots.length < 1">
            <p class="supervisor-places-label"><strong>Місць немає</strong></p>
          </div>

          <!-- Single slot -->
          <div class="slots-info single-slot supervisor-places-label" x-show="item.is_matched && item.free_slots.length === 1">
            <p><strong>Місць:</strong></p>
            <p class="supervisor-places-badge" x-text="item.free_slots[0].get_available_slots"></p>
          </div>

          <!-- Multiple slots -->
          <div class="slots-info multiple-slots supervisor-places-label" x-show="!item.is_matched && item.free_slots.length >= 1">
            <p><strong>Загальна кількість місць:</strong></p>
            <ul>
              <template x-for="slot in item.free_slots" :key="slot.id">
                <li>
                  <strong x-text="slot.stream_id.stream_code"></strong>:
                  <span x-text="slot.get_available_slots"></span>
                </li>
              </template>
            </ul>
          </div>
        </div>

      </div>
      <!-- Button on the card's right side that triggers HTMX to load the modal content. -->
      <div class="card-right-side">
        {% if user.is_authenticated and user.role == 'Студент'%}
          <template x-if="item.teacher.already_requested">
            <button class="modal-button tooltip-custom" disabled>
              <span class="arrow-icon">›</span>
              <span class="tooltiptext">Ви вже надіслали запит до цього викладача</span>
            </button>
          </template>
          <template x-if="!item.teacher.already_requested && item.has_active">
            <button class="modal-button tooltip-custom" disabled>
              <span class="arrow-icon">›</span>
              <span class="tooltiptext">У вас вже є активна робота</span>
            </button>
          </template>
          <template x-if="!item.teacher.already_requested && !item.has_active">
            <button class="modal-button"
              :data-teacher-id="item.teacher.id"
              :data-teacher-name="item.teacher.teacher_id.full_name"
              :data-teacher-url="item.teacher.url"
              @click="
                // Примусово оновлюємо HTMX атрибути перед кліком
                $el.setAttribute('hx-get', item.teacher.url);
                $el.setAttribute('hx-target', '#inner_modal');
                $el.setAttribute('hx-trigger', 'click');
                
                // Реініціалізуємо HTMX для цієї кнопки
                htmx.process($el);
                
                // Запускаємо запит вручну
                htmx.ajax('GET', item.teacher.url, {target: '#inner_modal'});
              ">
              <span class="arrow-icon">›</span>
            </button>
          </template>
        {% else %}
          <button class="modal-button tooltip-custom" disabled>
            <span class="arrow-icon">›</span>
            <span class="tooltiptext">У вас немає прав для надсилання запитів</span>
          </button>
        {% endif %}
      </div>
    </div> 
  </section>