{% extends "catalog/base.html" %}
{% load static %}
{%load widget_tweaks%} 
  <!-- 
  This template displays a list of teachers and highlights their available slots.
  It provides a modal dialog to submit requests. 
  When a user triggers the HX request (via button click), the modal is swapped in with HTMX. 
-->

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

{% block content %}

    <!-- Loop through 'data' which contains each teacher and their free slots. -->
    <div x-data="{ 
      data: [], 
      departments: [], 
      positions: [], 
      slots: null,
      show_occupied: false,
      full_names: [],
      searchQuery: '', 
      filteredData: [],  
      async initData() {
        this.data = await (await fetch('{% url 'teachers_list' %}')).json();  
        this.filteredData = this.data; 
      },
      applyFilters() {
        this.filteredData = this.data.filter(i =>
          (this.departments.length === 0 || this.departments.includes(i.teacher.teacher_id.department)) &&
          (this.positions.length === 0 || this.positions.includes(i.teacher.position)) &&
          (this.slots === null || i.free_slots.some(slot => slot.get_available_slots >= this.slots)) &&
          (this.show_occupied || i.free_slots.some(slot => slot.get_available_slots > 0))
        );
      },
      applySearch() {
        if (!this.searchQuery.trim()) {
          this.filteredData = this.data; // якщо запит порожній, показати всіх
          return;
        }
        
        this.filteredData = this.data.filter(i => {
          const fullName = (i.teacher.teacher_id.first_name + ' ' + i.teacher.teacher_id.last_name).toLowerCase();
          return fullName.includes(this.searchQuery.toLowerCase().trim());
        });
      }
    }" 
    x-init="initData()"> 
    <div class="search-section">
      <!-- A heading providing context for the search feature. -->
      <h1>Знайди свого ідеального наукового керівника!</h1> 
      <div class="search-container">
          <!-- Search input for filtering teachers (frontend only, no backend code). -->
          {% render_field form.searching class="form-searching" autocomplete="off" x-model="searchQuery" @keydown.enter="applySearch()" %}
          <button class="search-button" @click="applySearch()">
            <img src="{% static 'assets\img\search.svg' %}" alt="Search">
          </button>
      </div>
    </div>
    <div class="filter-panel" >
      <div class="filter-header">
          <h3>Фільтри</h3>
          <img src="{% static 'assets\img\filters.svg' %}" alt="Filters">
      </div>
      <div class="filter-content">
        <hr class='devider'></hr>
        <h3 class='option-label'>{{form.departments.label}}</h3>
        {% render_field form.departments class="form-checkbox" autocomplete="off" @change="departments = changeDepartments($el, departments)" %}
        <hr class='devider'></hr>
        <h3 class='option-label'>{{form.slots.label}}</h3>
        <div class="range-container">
          {% render_field form.slots class="form-range" autocomplete="off" @input="slots = $el.value" x-bind:disabled="show_occupied" %}
          <span class="range-value" x-text="slots || '0'"></span>
        </div>
        <hr class='devider'></hr>
        <hr class='devider'></hr>
        <hr class='devider'></hr>
        <h3 class='option-label'>{{form.positions.label}}</h3>
        {% render_field form.positions class="form-checkbox" autocomplete="off" @change="positions = changePositions($el, positions)" %}
        <hr class='devider'></hr>
        <div class="checkbox-wrapper">
          <span class="checkbox-text">Викладачі без вільних місць</span>
          {% render_field form.show_occupied class="form-boolean" autocomplete="off" @change="handleShowOccupied($el)" %}
        </div>
        <button class="filter-button" @click="applyFilters()">Фільтрувати</button>  
      </div> 
    </div>
    <template x-if="filteredData.length === 0">
      <div class="no-results">
        <h2>Нічого не знайдено!</h2>
      </div>
    </template>  
    <template x-for="item in filteredData">
        {% include "catalog/teacher_cards.html" %}
    </template>
    </div>



    <!-- A dialog element wrapping the HTMX content for the teacher modal. -->
    <dialog id="details_request_modal" class="modal">
      <div class="modal-box" id="inner_modal">
          <h3>Подати заявку</h3>
          <!-- Clicking this form's button closes the dialog. Actual request form is loaded via HTMX. -->
        <form method="dialog" class="modal-backdrop">
          <button>Close</button>
        </form> 
      </div>   
    </dialog> 
    
    <!-- Display any messages from Django's messages framework in a popup. -->
    {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="success-popup {{ message.tags }}">
          {% if message.tags == 'success' %}
            <img src="{% static 'images/toastIcon.svg' %}" alt="Success" class="success-icon" />
          {% elif message.tags == 'error' %}
            <img src="{% static 'images/errorIcon.svg' %}" alt="Error" class="success-icon" />
          {% endif %}
          <div class="popup-content">
            <p class="popup-title">
              {% if message.tags == 'success' %}
                Успіх!
              {% elif message.tags == 'error' %}
                Помилка!
              {% endif %}
            </p>
            <p class="popup-text">
              {{ message }}
            </p>
          </div>
          <i class="toast-close fas fa-times" onclick="closePopup()"></i>
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <script>
      /**
       * Updates the departments filter selection based on checkbox changes.
       * 
       * @param {HTMLElement} el - The checkbox element that was changed
       * @param {Array} departments - Current array of selected departments
       * @returns {Array} Updated array of selected departments
       */
      function changeDepartments(el, departments) {
        let department = el.value;
        if (departments.includes(department)) {
            return departments.filter(i => i !== department);
        } else {
            return [...departments, department];
        }
       }
      
      /**
       * Updates the positions filter selection based on checkbox changes.
       * 
       * @param {HTMLElement} el - The checkbox element that was changed
       * @param {Array} positions - Current array of selected positions
       * @returns {Array} Updated array of selected positions
       */
      function changePositions(el, positions) {
        let position = el.value;
        if (positions.includes(position)) {
            return positions.filter(i => i !== position);
        } else {
            return [...positions, position];
        }
      }
      
      /**
       * Handles changes to the 'show occupied' checkbox, updating Alpine.js data
       * and resetting the slots filter if checked.
       * 
       * @param {HTMLElement} el - The checkbox element that was changed
       */
      function handleShowOccupied(el) {
        const alpineData = Alpine.$data(el.closest('[x-data]'));
        alpineData.show_occupied = el.checked;
        if (el.checked) {
            alpineData.slots = null;
            const rangeInput = document.querySelector('input[type="range"]');
            rangeInput.value = rangeInput.min; // Reset to minimum value
        }
    }
      
      // Event listener triggered after the HTMX swap finishes inserting new content.
      document.addEventListener('htmx:afterSwap', function(event) {
          console.log("HTMX swap завершено", event.detail.target);
          // If the content is swapped into #inner_modal, show the modal dialog.
          if (event.detail.target.id === "inner_modal") { 
              document.getElementById('details_request_modal').showModal();
          }
      });

      // Before swapping in new content with HTMX, if there's no response, reload the page.
      document.addEventListener("htmx:beforeSwap", function(event) {
          if (event.detail.target.classList.contains("teacher-modal") && !event.detail.xhr.response) {
              location.reload();
          }
      });

      /**
       * Closes the popup message box when the 'Close' icon is clicked.
       */
      function closePopup() {
        const popup = document.querySelector('.success-popup');
        popup.style.display = 'none';
      }
  </script>
{% endblock %}