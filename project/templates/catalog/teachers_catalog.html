{% extends "catalog/base.html" %}
{% load static %}
{% load widget_tweaks %}

<!-- Added modern CSS stylesheet -->
<link rel="stylesheet" href="{% static 'css/modern-academic-style.css' %}">

<!-- 
This template displays a list of teachers and highlights their available slots.
It provides a modal dialog to submit requests. 
When a user triggers the HX request (via button click), the modal is swapped in with HTMX. 
-->

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

{% block content %}

<!-- Main container with Alpine.js state management -->
<div class="main-container-catalog" 
  x-data="{ 
     data: [], 
     departments: [], 
     slots: null,
     show_occupied: false,
     full_names: [], 
     searchQuery: '', 
     isLoading: true,
     showFilters: window.innerWidth > 780,
     isMobile: window.innerWidth <= 780,
     filteredTeachers: [],
     filteredThemes: [],
     filteredData: [],
     searchTeachers: true,
     searchThemes: false,
     allThemes: [],
     userHasActive: false,
     toggleFilters() {
       this.showFilters = !this.showFilters;
     },
     activeFiltersCount() {
       let count = 0;
       if (Array.isArray(this.departments)) count += this.departments.length;
       if (this.slots !== null && this.slots !== undefined && Number(this.slots) > 0) count += 1;
       if (this.show_occupied) count += 1;
       return count;
     },
     iconFor(label){
       const icons = ['üí°','üìò','üî¨','üß™','üß†','üíª','üåê'];
       const text = (label || '').toString();
       let hash = 0; for(let i=0;i<text.length;i++){ hash = (hash*31 + text.charCodeAt(i)) >>> 0; }
       return icons[hash % icons.length];
     },
     getThemeDesc(theme){
       if (theme && theme.theme_description) return theme.theme_description;
       try{
         const byId = this.allThemes && this.allThemes.find(t => t.id === theme.id);
         if (byId && byId.theme_description) return byId.theme_description;
         const byName = this.allThemes && this.allThemes.find(t => t.theme === theme.theme);
         if (byName && byName.theme_description) return byName.theme_description;
       }catch(e){}
       return '';
     },
     updateScreenSize() {
       this.isMobile = window.innerWidth <= 780;  // Ensure breakpoint matches CSS
       if (!this.isMobile) this.showFilters = true;
     },  
     async initData() {
      try {
        const response = await fetch('/catalog/teachers/');
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        if (data.error) {
          console.error('Server error:', data.error);
          this.data = [];
          this.filteredData = [];
          return;
        }
        this.data = data;
        this.filteredData = data.filter(i => i.free_slots.some(slot => slot.get_available_slots > 0));
        // user activity flag used to disable request buttons globally
        if (Array.isArray(data) && data.length > 0) {
          this.userHasActive = !!data.find(i => i.has_active === true);
        }
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ —Ç–µ–º–∏ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–µ–∑ –ø–æ—à—É–∫—É
        await this.loadAllThemes();
      } catch (error) {
        console.error('Error fetching data:', error);
        this.data = [];
        this.filteredData = [];
      }
      finally {
        this.isLoading = false;
      }
     },
     
     async loadAllThemes() {
      try {
        const response = await fetch('/catalog/themes/', {
          credentials: 'same-origin',
          headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        if (response.ok) {
          this.allThemes = await response.json();
        } else {
          console.error('Failed to load themes, status:', response.status);
        }
      } catch (error) {
        console.error('Error loading all themes:', error);
        this.allThemes = [];
      }
     },
          async applyAutocompleteSearch() {
      const query = this.searchQuery.trim().toLowerCase();
      this.filteredTeachers = [];
      this.filteredThemes = [];

      if (!query && !this.searchTeachers && !this.searchThemes) {
          this.filteredData = []; // No results if nothing is selected and no query
          return;
      }
      
      if (!query && this.searchTeachers && !this.searchThemes) {
          this.filteredData = this.data.filter(i => i.free_slots.some(slot => slot.get_available_slots > 0));
          return;
      }
      
      if (!query && this.searchThemes && !this.searchTeachers) {
          this.filteredThemes = this.allThemes; // —è–∫—â–æ –ø—É—Å—Ç–∏–π –∑–∞–ø–∏—Ç ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ —Ç–µ–º–∏
          this.filteredTeachers = [];
          this.filteredData = [];
          return;
      }
      
      if (!query && this.searchTeachers && this.searchThemes) {
          this.filteredData = this.data.filter(i => i.free_slots.some(slot => slot.get_available_slots > 0));
          this.filteredThemes = this.allThemes;
          return;
      }

      if (this.searchTeachers) {
          this.filteredTeachers = this.data.filter(i => {
              const teacher = i.teacher.teacher_id;
              const teacherName = `${teacher.first_name} ${teacher.last_name}`.toLowerCase();
              const hasSlots = this.show_occupied || i.free_slots.some(slot => slot.get_available_slots > 0);
              return teacherName.includes(query) && hasSlots;
          });
      }

      if (this.searchThemes) {
          try {
              const response = await fetch(`/catalog/themes/?q=${encodeURIComponent(query)}`, {
                  credentials: 'same-origin',
                  headers: {
                      'Accept': 'application/json',
                      'X-Requested-With': 'XMLHttpRequest'
                  }
              });
              if (!response.ok) throw new Error('Themes API error');
              const themes = await response.json();
              this.filteredThemes = themes;

              if (this.searchTeachers) {
                  const teacherIds = new Set(this.filteredTeachers.map(t => t.teacher.pk));
                  for (const theme of themes) {
                      if (!teacherIds.has(theme.teacher_id)) {
                          const teacher = this.data.find(i =>
                              i.teacher.pk === theme.teacher_id &&
                              (this.show_occupied || i.free_slots.some(slot => slot.get_available_slots > 0))
                          );
                          if (teacher) {
                              this.filteredTeachers.push(teacher);
                              teacherIds.add(theme.teacher_id);
                          }
                      }
                  }
              }
          } catch (error) {
              console.error('Error fetching themes:', error);
              this.filteredThemes = [];
          }
      }
      // —É —Ä–µ–∂–∏–º–∞—Ö –ø–æ—à—É–∫—É –º–∏ –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤
      this.filteredData = [];
     },
     
     selectThemeTeacher(teacherId) {
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤–∏–∫–ª–∞–¥–∞—á–∞ –≤ –¥–∞–Ω–∏—Ö
        const teacher = this.data.find(item => item.teacher.pk === teacherId);
        if (teacher) {
            // –ü–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ü—å–æ–≥–æ –≤–∏–∫–ª–∞–¥–∞—á–∞ –≤ –ª—ñ–≤—ñ–π –∫–æ–ª–æ–Ω—Ü—ñ
            this.filteredTeachers = [teacher];
            // –û—á–∏—â–∞—î–º–æ —Ç–µ–º–∏
            this.filteredThemes = [];
        }
     },
     
    // –ü–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫ —Ç–µ–º –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–∏–∫–ª–∞–¥–∞—á–∞
    themesForTeacher(item) {
       if (!item || !this.allThemes || this.allThemes.length === 0) return [];
       const candidateIds = [];
       if (item?.teacher?.pk) candidateIds.push(item.teacher.pk);
       if (item?.teacher?.id) candidateIds.push(item.teacher.id);
       if (typeof item?.teacher?.teacher_id === 'number') candidateIds.push(item.teacher.teacher_id);
       if (typeof item?.teacher?.teacher_id?.id === 'number') candidateIds.push(item.teacher.teacher_id.id);
       return this.allThemes.filter(t => candidateIds.includes(t.teacher_id));
    },
    
     filterByTeacherIds(teacherIds) {
        const filtered = this.data.filter(item => {
            const teacherPk = item.teacher?.pk || item.teacher?.id;
            const hasSlots = this.show_occupied || item.free_slots.some(slot => slot.get_available_slots > 0);
            const isIncluded = teacherIds.includes(teacherPk);
            return isIncluded && hasSlots;
        });
        
        this.filteredData = filtered;
        
        // –û–Ω–æ–≤–ª—é—î–º–æ HTMX –∞—Ç—Ä–∏–±—É—Ç–∏ –ø—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è
        this.$nextTick(() => {
            this.updateHTMXAttributes();
        });
     },
     
     updateHTMXAttributes() {
        const buttons = document.querySelectorAll('.modal-button[hx-get]');
        buttons.forEach(button => {
            const teacherCard = button.closest('.teacher-card');
            if (teacherCard && teacherCard.__x) {
                const item = teacherCard.__x.$data.item;
                if (item && item.teacher && item.teacher.url) {
                    button.setAttribute('hx-get', item.teacher.url);
                }
            }
        });
     },
     
     showModal() {
        const modal = document.getElementById('details_request_modal');
        if (!modal) {
            console.error('Modal element not found!');
            return;
        }
        try {
            modal.showModal();
        } catch (error) {
            console.error('Error showing modal:', error);
        }
     },
     
     selectThemeAndShowModal(themeTeacherId) {
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤–∏–∫–ª–∞–¥–∞—á–∞ –≤ –¥–∞–Ω–∏—Ö (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ teacher.id –∑–∞–º—ñ—Å—Ç—å teacher.pk)
        let teacher = this.data.find(item => item.teacher.pk === themeTeacherId);
        if (!teacher) {
            teacher = this.data.find(item => item.teacher.id === themeTeacherId);
        }
        if (!teacher) {
            teacher = this.data.find(item => item.teacher.teacher_id === themeTeacherId);
        }
        
        if (teacher && teacher.teacher.url) {
            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
            this.selectThemeTeacher(themeTeacherId);
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª–∫—É
            this.showModal();
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ HTMX
            htmx.ajax('GET', teacher.teacher.url, {target: '#inner_modal'});
        }
     }
  }" 
  x-init="
    await initData();
    await loadAllThemes();
    updateScreenSize(); 
    window.addEventListener('resize', updateScreenSize);
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –∑ –∞–≤—Ç–æ–∫–æ–º–ø–ª—ñ—Ç—É
    window.catalogMainComponent = $data;
  "
  @update-search.window="
    console.log('Received search event:', $event.detail);
    searchQuery = $event.detail.query;
    applyAutocompleteSearch()
  "
  @search-query.window="searchQuery = $event.detail.query; applyAutocompleteSearch()"
  
    <!-- Desktop filter wrapper (hidden on mobile) -->
    <div class="filter-wrapper" x-show="!isMobile" x-cloak>
      <!-- Search Mode Switchers move to sidebar on desktop -->
      <div class="search-mode-switchers">
        <div class="switcher-header">
          <h4>–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –ø–æ—à—É–∫—É:</h4>
        </div>
        <div class="segment-switcher">
          <button class="segment-btn"
                  :class="{ 'active': searchTeachers && !searchThemes }"
                  @click="searchTeachers = true; searchThemes = false; applyAutocompleteSearch()">
            –í–∏–∫–ª–∞–¥–∞—á—ñ
          </button>
          <button class="segment-btn"
                  :class="{ 'active': searchThemes && !searchTeachers }"
                  @click="searchThemes = true; searchTeachers = false; applyAutocompleteSearch()">
            –¢–µ–º–∏
          </button>
          <button class="segment-btn"
                  :class="{ 'active': searchTeachers && searchThemes }"
                  @click="searchTeachers = true; searchThemes = true; applyAutocompleteSearch()">
            –í—Å—ñ
          </button>
        </div>
      </div>
      <div class="filter-section shadow-sm">
        <div class="filter-header">
        <h3>–§—ñ–ª—å—Ç—Ä–∏</h3>
        <img src="{% static 'images/filters.svg' %}" alt="Filters">
        </div>
        <div class="filter-content">
        <hr class="devider">
        <h3 class="option-label">{{ form.departments.label }}</h3>
        {% render_field form.departments class="form-checkbox" autocomplete="off" @change="departments = changeDepartments($el, departments)" %}
        
        <hr class="devider">
        <h3 class="option-label">{{ form.slots.label }}</h3>
        <div class="range-container">
        <template x-if="show_occupied">
            {% render_field form.slots class="form-range" autocomplete="off" x-bind="{disabled: show_occupied}" @input="slots = $el.value" %}
        </template>
        <template x-if="!show_occupied">
            {% render_field form.slots class="form-range" autocomplete="off" @input="slots = $el.value" %}
        </template>
        <span class="range-value" x-text="slots || '0'"></span>
        </div>

        <hr class="devider">
        <div class="checkbox-wrapper">
        <span class="checkbox-text">–í–∏–∫–ª–∞–¥–∞—á—ñ –±–µ–∑ –≤—ñ–ª—å–Ω–∏—Ö –º—ñ—Å—Ü—å</span>
        {% render_field form.show_occupied class="form-boolean" autocomplete="off" @change="handleShowOccupied($el)" %}
        </div>
        <button class="filter-button" @click="applyFilters()">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
        </div>
      </div>
    </div>

    <!-- Content Section -->
    <div class="content-section">
     <!-- Search Section -->
     <div class="search-section">
       <div class="search-header">
         <h1>–ó–Ω–∞–π–¥–∏ —Å–≤–æ–≥–æ –Ω–∞—É–∫–æ–≤–æ–≥–æ –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞!
           <button id="start-tour-catalog" class="help-icon-btn desktop-help-btn" title="–î–æ–ø–æ–º–æ–≥–∞ –∑ –ø–æ—à—É–∫–æ–º">
             <i class="fas fa-question-circle"></i>
           </button>
           <button id="start-tour-catalog-mobile" class="help-icon-btn mobile-help-btn" title="–î–æ–ø–æ–º–æ–≥–∞ –∑ –ø–æ—à—É–∫–æ–º">
             <i class="fas fa-question-circle"></i>
           </button>
         </h1>
       </div>
      <!-- Mobile: show type switchers on top (card) -->
      <div class="search-mode-switchers" x-show="isMobile" x-cloak>
        <div class="switcher-header">
          <h4>–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –ø–æ—à—É–∫—É:</h4>
        </div>
        <div class="segment-switcher">
          <button class="segment-btn"
                  :class="{ 'active': searchTeachers && !searchThemes }"
                  @click="searchTeachers = true; searchThemes = false; applyAutocompleteSearch()">
            –í–∏–∫–ª–∞–¥–∞—á—ñ
          </button>
          <button class="segment-btn"
                  :class="{ 'active': searchThemes && !searchTeachers }"
                  @click="searchThemes = true; searchTeachers = false; applyAutocompleteSearch()">
            –¢–µ–º–∏
          </button>
          <button class="segment-btn"
                  :class="{ 'active': searchTeachers && searchThemes }"
                  @click="searchTeachers = true; searchThemes = true; applyAutocompleteSearch()">
            –í—Å—ñ
          </button>
        </div>
      </div>
      <div class="autocomplete-wrapper" x-data="autocompleteSearch()" style="position: relative;">
        <div class="search-container autocomplete-container">
         <input type="text" 
                class="form-searching" 
                placeholder="–ü–æ—à—É–∫ –≤–∏–∫–ª–∞–¥–∞—á–∞ —á–∏ —Ç–µ–º–∏..."
                x-model="query"
                @input="handleInput"
                @keydown.enter="handleEnter"
                @keydown.escape="hideSuggestions"
                @focus="showSuggestionsIfQuery"
                @blur="setTimeout(() => hideSuggestions(), 150)"
                autocomplete="off">
         <button class="search-button" @click="handleSearch">
          <img src="{% static 'images/search.svg' %}" alt="Search">
         </button>
        </div>
         
         <!-- Autocomplete suggestions -->
         <!-- Suggestions disabled: results render inline below -->
         <div class="autocomplete-suggestions" x-show="false"></div>
      </div>
      <!-- Mobile collapsible top filter bar -->
        <div class="mobile-filter-bar" x-show="isMobile" @click="toggleFilters()">
          <div class="bar-left">
            <img src="{% static 'images/filters.svg' %}" alt="Filters" class="bar-icon">
            <span class="bar-title">–§—ñ–ª—å—Ç—Ä–∏</span>
          </div>
          <div class="bar-right">
            <button type="button" class="bar-chev-btn" :class="{ open: showFilters }" aria-label="–ü–µ—Ä–µ–º–∏–∫–∞—á —Ñ—ñ–ª—å—Ç—Ä—ñ–≤" tabindex="-1">
              <span class="bar-chev-icon" :class="{ open: showFilters }">‚ñæ</span>
            </button>
          </div>
        </div>
        <!-- Mobile inline filter panel (expands under the bar) -->
        <div x-show="isMobile && showFilters"
             x-transition.opacity.duration.200ms
             class="filter-section shadow-sm"
             x-cloak>
          <div class="filter-content">
            <h3 class="option-label">{{ form.departments.label }}</h3>
            {% render_field form.departments class="form-checkbox" autocomplete="off" @change="departments = changeDepartments($el, departments)" %}

            <hr class="devider">
            <h3 class="option-label">{{ form.slots.label }}</h3>
            <div class="range-container">
              <template x-if="show_occupied">
                {% render_field form.slots class="form-range" autocomplete="off" x-bind="{disabled: show_occupied}" @input="slots = $el.value" %}
              </template>
              <template x-if="!show_occupied">
                {% render_field form.slots class="form-range" autocomplete="off" @input="slots = $el.value" %}
              </template>
              <span class="range-value" x-text="slots || '0'"></span>
            </div>

            <hr class="devider">
            <div class="checkbox-wrapper">
              <span class="checkbox-text">–í–∏–∫–ª–∞–¥–∞—á—ñ –±–µ–∑ –≤—ñ–ª—å–Ω–∏—Ö –º—ñ—Å—Ü—å</span>
              {% render_field form.show_occupied class="form-boolean" autocomplete="off" @change="handleShowOccupied($el)" %}
            </div>
            <button class="filter-button" @click="applyFilters(); isMobile && (showFilters = false)">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
          </div>
        </div>
     </div>

     <!-- Main Results Container -->
     <div class="search-results" x-cloak>
       <!-- Loading State -->
       <div class="loader-container" x-show="isLoading">
         <div class="loader"></div>
       </div>

       <!-- Results -->
       <div x-show="!isLoading">
         <!-- No Results Message -->
         <div class="no-results" 
              x-show="searchQuery.trim() && filteredTeachers.length === 0 && filteredThemes.length === 0">
           <div class="search-icon-wrapper">
             <svg xmlns="http://www.w3.org/2000/svg" class="search-icon" viewBox="0 0 24 24">
               <circle cx="11" cy="11" r="8"></circle>
               <line x1="21" y1="21" x2="16.7" y2="16.7"></line>
             </svg>
           </div>
           <h2>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!</h2>
           <p>–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—ó –ø–æ—à—É–∫—É –∞–±–æ —Ñ—ñ–ª—å—Ç—Ä–∏.</p>
         </div>

        <!-- Unified Results Layout -->
        <div class="unified-results" x-show="searchQuery.trim() && (filteredTeachers.length > 0 || filteredThemes.length > 0)">
           <!-- Teachers Results (only teachers mode) -->
           <div class="results-section" x-show="searchTeachers && !searchThemes && filteredTeachers.length > 0">
             <h3>–í–∏–∫–ª–∞–¥–∞—á—ñ (<span x-text="filteredTeachers.length"></span>)</h3>
             <div class="teachers-list">
               <template x-for="(item, index) in filteredTeachers || []" :key="item?.teacher?.pk || index">
                 {% include "catalog/teacher_cards.html" %}
               </template>
             </div>
           </div>

           <!-- Themes Results (only themes mode) -->
           <div class="results-section" x-show="searchThemes && !searchTeachers && filteredThemes.length > 0">
             <h3>–¢–µ–º–∏ —Ä–æ–±—ñ—Ç (<span x-text="filteredThemes.length"></span>)</h3>
             <div class="themes-list">
               <template x-for="(theme, index) in filteredThemes || []" :key="theme?.id || index">
                <div class="topic-card">
                  <h5 class="topic-name" x-text="theme.theme"></h5>
                  <p class="theme-teacher" x-text="'–í–∏–∫–ª–∞–¥–∞—á: ' + theme.teacher_name"></p>
                  <template x-if="theme.theme_description">
                    <p class="topic-description" x-text="theme.theme_description"></p>
                  </template>
                  <button class="theme-select-btn" :disabled="userHasActive"
                          @click="!userHasActive && selectThemeAndShowModal(theme.teacher_id)">
                    –û–±—Ä–∞—Ç–∏ –≤–∏–∫–ª–∞–¥–∞—á–∞
                  </button>
                </div>
               </template>
             </div>
           </div>

           <!-- Combined Results (both teachers and themes) -->
          <div class="results-section" x-show="searchTeachers && searchThemes && (filteredTeachers.length > 0 || filteredThemes.length > 0)">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h3>
            <!-- Teachers subsection -->
            <div class="catalog-container" x-show="filteredTeachers.length > 0">
              <template x-for="(item, index) in filteredTeachers || []" :key="item?.teacher?.pk || index">
                <div class="teacher-with-themes" x-data="{ expanded: false }">
                  {% include "catalog/teacher_cards.html" %}
                  <div class="topics-container attach" x-show="themesForTeacher(item).length > 0" x-transition>
                    <div class="topics-toggle-bar compact">
                      <div class="topics-inline">
                        <span class="topics-inline-label">–î–æ—Å—Ç—É–ø–Ω—ñ —Ç–µ–º–∏:</span>
                        <div class="topics-chips">
                          <template x-for="(t, i) in themesForTeacher(item)" :key="t?.id || i">
                            <span class="topic-chip" x-text="t.theme"></span>
                          </template>
                        </div>
                      </div>
                      <div class="topics-actions">
                        <button type="button" class="toggle-topics-btn" @click="expanded = !expanded">
                          <span x-text="expanded ? '–ó–≥–æ—Ä–Ω—É—Ç–∏' : '–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–µ–º–∏'"></span>
                          <span class="chev" :class="{ up: expanded }">‚ñæ</span>
                        </button>
                      </div>
                    </div>
                    <div class="topics-grid enhanced" x-show="expanded">
                      <template x-for="(theme, tIndex) in themesForTeacher(item)" :key="theme?.id || tIndex">
                        <div class="topic-card">
                          <h5 class="topic-name" x-text="theme.theme"></h5>
                          <template x-if="getThemeDesc(theme)">
                            <p class="topic-description" x-text="getThemeDesc(theme)"></p>
                          </template>
                          <button class="theme-select-btn" :disabled="userHasActive" @click="!userHasActive && selectThemeAndShowModal(theme.teacher_id)">–û–±—Ä–∞—Ç–∏ –≤–∏–∫–ª–∞–¥–∞—á–∞</button>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </template>
            </div>

            <!-- Themes subsection -->
            <div class="themes-list" x-show="filteredThemes.length > 0" style="margin-top:16px;">
              <template x-for="(theme, index) in filteredThemes || []" :key="theme?.id || index">
                <div class="topic-card">
                  <h5 class="topic-name" x-text="theme.theme"></h5>
                  <template x-if="theme.theme_description">
                    <p class="topic-description" x-text="theme.theme_description"></p>
                  </template>
                  <button class="theme-select-btn" :disabled="userHasActive" @click="!userHasActive && selectThemeAndShowModal(theme.teacher_id)">–û–±—Ä–∞—Ç–∏ –≤–∏–∫–ª–∞–¥–∞—á–∞</button>
                </div>
              </template>
            </div>
          </div>
         </div>
 
         <!-- Default View (all teachers or all themes) -->
         <div class="all-content" x-show="!searchQuery.trim()">
           <!-- No Teachers Message -->
           <div class="no-results" 
                x-show="searchTeachers && !searchThemes && filteredData.length === 0">
             <div class="search-icon-wrapper">
               <svg xmlns="http://www.w3.org/2000/svg" class="search-icon" viewBox="0 0 24 24">
                 <circle cx="11" cy="11" r="8"></circle>
                 <line x1="21" y1="21" x2="16.7" y2="16.7"></line>
               </svg>
             </div>
             <h2>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!</h2>
             <p>–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—ó –ø–æ—à—É–∫—É –∞–±–æ —Ñ—ñ–ª—å—Ç—Ä–∏.</p>
           </div>
           
           <!-- All Teachers View -->
           <div class="results-section" x-show="searchTeachers && !searchThemes && filteredData.length > 0">
             <h3>–í—Å—ñ –≤–∏–∫–ª–∞–¥–∞—á—ñ</h3>
             <div class="teachers-list">
               <template x-for="(item, index) in filteredData || []" :key="item?.teacher?.pk || index">
                 {% include "catalog/teacher_cards.html" %}
               </template>
             </div>
           </div>
           
           <!-- No Themes Message -->
           <div class="no-results" 
                x-show="searchThemes && !searchTeachers && allThemes.length === 0">
             <div class="search-icon-wrapper">
               <svg xmlns="http://www.w3.org/2000/svg" class="search-icon" viewBox="0 0 24 24">
                 <circle cx="11" cy="11" r="8"></circle>
                 <line x1="21" y1="21" x2="16.7" y2="16.7"></line>
               </svg>
             </div>
             <h2>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!</h2>
             <p>–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—ó –ø–æ—à—É–∫—É –∞–±–æ —Ñ—ñ–ª—å—Ç—Ä–∏.</p>
           </div>
           
           <!-- All Themes View -->
           <div class="results-section" x-show="searchThemes && !searchTeachers && allThemes.length > 0">
             <h3>–í—Å—ñ —Ç–µ–º–∏ —Ä–æ–±—ñ—Ç (<span x-text="allThemes.length"></span>)</h3>
             <div class="themes-list enhanced">
               <template x-for="(theme, index) in allThemes || []" :key="theme?.id || index">
                <div class="topic-card">
                  <h5 class="topic-name" x-text="theme.theme"></h5>
                  <p class="theme-teacher" x-text="'–í–∏–∫–ª–∞–¥–∞—á: ' + theme.teacher_name"></p>
                  <template x-if="theme.theme_description">
                    <p class="topic-description" x-text="theme.theme_description"></p>
                  </template>
                  <button class="theme-select-btn" :disabled="userHasActive"
                          @click="!userHasActive && selectThemeAndShowModal(theme.teacher_id)">
                    –û–±—Ä–∞—Ç–∏ –≤–∏–∫–ª–∞–¥–∞—á–∞
                  </button>
                </div>
               </template>
             </div>
           </div>
           
           <!-- No Combined Results Message -->
           <div class="no-results" 
                x-show="searchTeachers && searchThemes && filteredData.length === 0">
             <div class="search-icon-wrapper">
               <svg xmlns="http://www.w3.org/2000/svg" class="search-icon" viewBox="0 0 24 24">
                 <circle cx="11" cy="11" r="8"></circle>
                 <line x1="21" y1="21" x2="16.7" y2="16.7"></line>
               </svg>
             </div>
             <h2>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!</h2>
             <p>–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—ó –ø–æ—à—É–∫—É –∞–±–æ —Ñ—ñ–ª—å—Ç—Ä–∏.</p>
           </div>
           
           <!-- Combined default view (both teachers and their themes) -->
           <div class="results-section" x-show="searchTeachers && searchThemes && filteredData.length > 0">
             <h3>–í—Å—ñ –≤–∏–∫–ª–∞–¥–∞—á—ñ —Ç–∞ —ó—Ö —Ç–µ–º–∏</h3>
             <div class="catalog-container">
               <template x-for="(item, index) in filteredData || []" :key="item?.teacher?.pk || index">
                 <div class="teacher-with-themes" x-data="{ expanded: false }">
                   {% include "catalog/teacher_cards.html" %}
                   <div class="topics-container attach" x-show="themesForTeacher(item).length > 0" x-transition>
                     <div class="topics-toggle-bar compact">
                       <div class="topics-inline">
                         <span class="topics-inline-label">–î–æ—Å—Ç—É–ø–Ω—ñ —Ç–µ–º–∏:</span>
                         <div class="topics-chips">
                           <template x-for="(t, i) in themesForTeacher(item)" :key="t?.id || i">
                             <span class="topic-chip" x-text="t.theme"></span>
                           </template>
                         </div>
                       </div>
                       <div class="topics-actions">
                         <button type="button" class="toggle-topics-btn" @click="expanded = !expanded">
                           <span x-text="expanded ? '–ó–≥–æ—Ä–Ω—É—Ç–∏' : '–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–µ–º–∏'"></span>
                           <span class="chev" :class="{ up: expanded }">‚ñæ</span>
                         </button>
                       </div>
                     </div>
                     <div class="topics-grid enhanced" x-show="expanded">
                       <template x-for="(theme, tIndex) in themesForTeacher(item)" :key="theme?.id || tIndex">
                         <div class="topic-card">
                           <h5 class="topic-name" x-text="theme.theme"></h5>
                           <template x-if="getThemeDesc(theme)">
                             <p class="topic-description" x-text="getThemeDesc(theme)"></p>
                           </template>
                           <button class="theme-select-btn" :disabled="userHasActive" @click="!userHasActive && selectThemeAndShowModal(theme.teacher_id)">–û–±—Ä–∞—Ç–∏ –≤–∏–∫–ª–∞–¥–∞—á–∞</button>
                         </div>
                       </template>
                     </div>
                   </div>
                 </div>
               </template>
             </div>
           </div>
         </div>
       </div>
     </div>
    </div>
</div>

<!-- Modal Dialog for Request Submission -->
<dialog id="details_request_modal" class="modal">
    <div class="modal-box" id="inner_modal">
     <h3>–ü–æ–¥–∞—Ç–∏ –∑–∞—è–≤–∫—É</h3>
     <form method="dialog" class="modal-backdrop">
      <button>Close</button>
     </form>
    </div>
</dialog>


<!-- Messages -->
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="success-popup {{ message.tags }}">
                {% if message.tags == 'success' %}
                    <img src="{% static 'images/toastIcon.svg' %}" alt="Success" class="success-icon" />
                {% elif message.tags == 'error' %}
                    <img src="{% static 'images/errorIcon.svg' %}" alt="Error" class="success-icon" />
                {% endif %}
                <div>
                    <div class="popup-content">
                        <p class="popup-title">
                            {% if message.tags == 'success' %}–£—Å–ø—ñ—Ö!{% elif message.tags == 'error' %}–ü–æ–º–∏–ª–∫–∞!{% endif %}
                        </p>
                        <p class="popup-text">{{ message }}</p>
                    </div>
                    <i class="toast-close fas fa-times close" onclick="closePopup()"></i>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}

<!-- External JavaScript Files -->
<script src="{% static 'js/teacher_modal.js' %}"></script>
<script src="{% static 'js/filtering.js' %}"></script>

<script>
// –ê–≤—Ç–æ–∫–æ–º–ø–ª—ñ—Ç –¥–ª—è –ø–æ—à—É–∫—É –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ —Ç–∞ —Ç–µ–º
function autocompleteSearch() {
    return {
        query: '',
        suggestions: [],
        showSuggestions: false,
        highlightedIndex: -1,
        debounceTimer: null,
        
        init() {
            // Component initialized
        },
        
        async handleInput() {
            if (this.debounceTimer) {
                clearTimeout(this.debounceTimer);
            }
            
            this.debounceTimer = setTimeout(() => {
                this.fetchSuggestions();
            }, 300);
        },
        
        async fetchSuggestions() {
            if (this.query.length < 2) {
                this.suggestions = [];
                this.showSuggestions = false;
                return;
            }
            
            try {
                const url = `/catalog/autocomplete/?q=${encodeURIComponent(this.query)}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    this.suggestions = await response.json();
                    this.showSuggestions = this.suggestions.length > 0;
                    this.highlightedIndex = -1;
                } else {
                    this.suggestions = [];
                    this.showSuggestions = false;
                }
            } catch (error) {
                console.error('Network error:', error);
                this.suggestions = [];
                this.showSuggestions = false;
            }
        },
        
        selectSuggestion(suggestion) {
            this.query = suggestion.label.replace(/^(üë®‚Äçüè´|üìö) /, '');
            this.suggestions = [];
            this.showSuggestions = false;
            
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ searchQuery –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ —Ç–∞ –∑–∞–ø—É—Å–∫–∞—î–º–æ –ø–æ—à—É–∫
            if (window.catalogMainComponent) {
                window.catalogMainComponent.searchQuery = this.query;
                window.catalogMainComponent.applyAutocompleteSearch();
            }
            
            this.hideSuggestions();
        },
        
        filterByTeacher(teacherId) {
            if (window.catalogMainComponent && window.catalogMainComponent.filterByTeacherIds) {
                window.catalogMainComponent.filterByTeacherIds([teacherId]);
            }
        },
        
        async filterByTheme(themeId) {
            try {
                // –†–æ–±–∏–º–æ –∑–∞–ø–∏—Ç –¥–æ –±–µ–∫–µ–Ω–¥—É –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ –∑ —Ü—ñ—î—é —Ç–µ–º–æ—é
                const response = await fetch(`/catalog/autocomplete/theme/${themeId}/teachers/`);
                if (response.ok) {
                    const teacherIds = await response.json();
                    
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
                    if (window.catalogMainComponent && window.catalogMainComponent.filterByTeacherIds) {
                        window.catalogMainComponent.filterByTeacherIds(teacherIds);
                    }
                } else {
                    // Fallback: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤—ñ —Ç–µ–º–∏
                    const themeName = this.suggestions.find(s => s.id === themeId && s.type === 'theme')?.label.replace('üìö ', '') || '';
                    this.query = themeName;
                    this.handleSearch();
                }
            } catch (error) {
                // Fallback: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤—ñ —Ç–µ–º–∏
                const themeName = this.suggestions.find(s => s.id === themeId && s.type === 'theme')?.label.replace('üìö ', '') || '';
                this.query = themeName;
                this.handleSearch();
            }
        },
        
        filterByTeacher(teacherId) {
            if (window.catalogMainComponent && window.catalogMainComponent.filterByTeacherIds) {
                window.catalogMainComponent.filterByTeacherIds([teacherId]);
            }
        },
        
        async filterByTheme(themeId) {
            try {
                // –†–æ–±–∏–º–æ –∑–∞–ø–∏—Ç –¥–æ –±–µ–∫–µ–Ω–¥—É –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ –∑ —Ü—ñ—î—é —Ç–µ–º–æ—é
                const response = await fetch(`/catalog/autocomplete/theme/${themeId}/teachers/`);
                if (response.ok) {
                    const teacherIds = await response.json();
                    
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
                    if (window.catalogMainComponent && window.catalogMainComponent.filterByTeacherIds) {
                        window.catalogMainComponent.filterByTeacherIds(teacherIds);
                    }
                } else {
                    // Fallback: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤—ñ —Ç–µ–º–∏
                    const themeName = this.suggestions.find(s => s.id === themeId && s.type === 'theme')?.label.replace('üìö ', '') || '';
                    this.query = themeName;
                    this.handleSearch();
                }
            } catch (error) {
                // Fallback: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤—ñ —Ç–µ–º–∏
                const themeName = this.suggestions.find(s => s.id === themeId && s.type === 'theme')?.label.replace('üìö ', '') || '';
                this.query = themeName;
                this.handleSearch();
            }
        },
        
        handleEnter() {
            if (this.highlightedIndex >= 0 && this.suggestions[this.highlightedIndex]) {
                this.selectSuggestion(this.suggestions[this.highlightedIndex]);
            } else {
                this.handleSearch();
            }
        },
        
        handleSearch() {
            // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –∞–≤—Ç–æ–∫–æ–º–ø–ª—ñ—Ç
            this.hideSuggestions();
            
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ searchQuery –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ —Ç–∞ –∑–∞–ø—É—Å–∫–∞—î–º–æ –ø–æ—à—É–∫
            if (window.catalogMainComponent) {
                window.catalogMainComponent.searchQuery = this.query;
                window.catalogMainComponent.applyAutocompleteSearch();
            }
        },
        
        hideSuggestions() {
            this.showSuggestions = false;
            this.highlightedIndex = -1;
        },
        
        showSuggestionsIfQuery() {
            if (this.query.length >= 2 && this.suggestions.length > 0) {
                this.showSuggestions = true;
            }
        }
    };
}
</script>



{% endblock %}
