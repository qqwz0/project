{% load catalog_extras %}
{% load static %}

<div id="profile-content">
    <!-- –î–æ–¥–∞—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
{% block content %}
    {% if user.role == "–°—Ç—É–¥–µ–Ω—Ç" %}
    {% if active_requests %}
            <h2>üìù –ê–∫—Ç–∏–≤–Ω—ñ —Ä–æ–±–æ—Ç–∏</h2>
            {% for request_obj in active_requests %}
            <div class="request-card">
                <div class="request-user">
                    <img src="{% get_profile_picture_url request_obj.teacher_id.teacher_id %}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    <div class="user-info">
                        <a href="{% url 'profile_detail' request_obj.teacher_id.teacher_id.id %}" class="profile-link">
                            {{ request_obj.teacher_id.teacher_id.get_full_name }}
                        </a>
                        <p class="role">{{ request_obj.teacher_id.teacher_id.role }}</p>
                        {% if request_obj.custom_student_theme %}
                            <strong>–¢–µ–º–∞:</strong>
                            <p class="theme">{{ request_obj.custom_student_theme }} <span style="color:#888;font-size:0.9em;">(–¥–æ–≤—ñ–ª—å–Ω–∞ —Ç–µ–º–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞)</span></p>
                        {% elif request_obj.approved_student_theme %}
                            <strong>–¢–µ–º–∞:</strong>
                            <p class="theme">{{ request_obj.approved_student_theme.theme }} <span style="color:#888;font-size:0.9em;">(–∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–º)</span></p>
                        {% elif request_obj.teacher_theme %}
                            <strong>–¢–µ–º–∞:</strong>
                            <p class="theme">{{ request_obj.teacher_theme.theme }}</p>
                        {% endif %}
                        {% if request_obj.student_themes.all %}
                            <strong>–¢–µ–º–∞—Ç–∏–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞:</strong>
                            <ul class="student-themes-list">
                                {% for theme in request_obj.student_themes.all %}
                                    <li>{{ theme.theme }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        <strong>–ú–æ—Ç–∏–≤–∞—Ü—ñ—è:</strong>
                        <p class="motivation">{{ request_obj.motivation_text }}</p>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü—ñ—è —Ñ–∞–π–ª—ñ–≤ -->
                <div class="files-section mt-4">
                        {% with files=active_request_files|get_item:request_obj.id %}
                            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–∞–π–ª—ñ–≤ –∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º —É—Å–µ—Ä–µ–¥–∏–Ω—ñ -->
                            <div class="files-scroll-container">
                                <div class="files-header">–§–∞–π–ª–∏</div>
                                {% for file in files %}
                                    <div class="file-block">
                                        <div class="file-header">
                                            <div class="file-title-block">
                                                <div class="file-name file-name-ellipsis">{{ file.get_filename }}</div>
                                                <div class="file-meta">
                                                    <span class="file-owner">{{ file.uploaded_by.get_full_name }}</span>
                                                    <span class="file-dot">¬∑</span>
                                                    <span class="file-role">{{ file.uploaded_by.role }}</span>
                                                    {% if file.uploaded_at %}
                                                    <span class="file-dot">¬∑</span>
                                                    <span class="file-date">{{ file.uploaded_at|date:"Y-m-d H:i" }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="file-actions">
                                                <a href="{% url 'download_file' file.pk %}" class="download-button">
                                                    <i class="fas fa-download download-icon"></i>
                                                    <span>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</span>
                                                </a>
                                                {% if user == file.uploaded_by %}
                                                    <button class="delete-file-btn" data-file-id="{{ file.pk }}" data-url="{% url 'delete_file' file.pk %}">
                                                        <i class="fas fa-trash delete-icon"></i>
                                                        <span>–í–∏–¥–∞–ª–∏—Ç–∏</span>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="file-description-block">
                                            {% if file.description %}
                                                <p class="file-description-text subtle">{{ file.description }}</p>
                                            {% endif %}
                                        </div>

                                        <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ (–æ–±–∏–¥–≤—ñ —Ä–æ–ª—ñ) -->
                                        <div class="file-comments">
                                            <div class="comments-header">
                                                <span>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ ({{ file.comments.count }})</span>
                                            </div>
                                            <div class="comments-list">
                                                {% for comment in file.comments.all %}
                                                    <div class="comment-block {% if comment.author.role == '–í–∏–∫–ª–∞–¥–∞—á' %}teacher-bg{% else %}student-bg{% endif %}" data-comment-id="{{ comment.id }}">
                                                        {% if comment.parent %}
                                                        <!-- –¶–∏—Ç—É–≤–∞–Ω–Ω—è –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ –∫–æ–º–µ–Ω—Ç–∞—Ä—è -->
                                                        <div class="quoted-comment">
                                                            <div class="quoted-comment-header">
                                                                <span class="quoted-author">{{ comment.parent.author.get_full_name }}</span>
                                                                <span class="quoted-date">{{ comment.parent.created_at|date:"d.m.y H:i" }}</span>
                                                            </div>
                                                            <p class="quoted-text">{{ comment.parent.text|truncatechars:100 }}</p>
                                                        </div>
                                                        {% endif %}
                                                        <div class="comment-header">
                                                            <span class="comment-author">{{ comment.author.get_full_name }}</span>
                                                            <span class="comment-date">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                                                        </div>
                                                        <p class="comment-text">{{ comment.text }}</p>
                                                        {% if comment.attachment %}
                                                        <div class="attachment-block">
                                                            <a href="{{ comment.attachment.url }}" download class="attachment-link">
                                                                <i class="fas fa-paperclip attachment-icon"></i>
                                                                <span class="attachment-filename">{{ comment.get_attachment_filename }}</span>
                                                            </a>
                                                        </div>
                                                        {% endif %}
                                                        <div class="comment-actions">
                                                            <button class="reply-btn" type="button" data-parent-id="{{ comment.id }}" data-author="{{ comment.author.get_full_name }}">–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
                                                            {% if user == comment.author %}
                                                            <button class="delete-comment-btn" data-comment-id="{{ comment.id }}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% empty %}
                                                    <p class="no-files" style="margin: 8px 0 0;">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ —â–µ –Ω–µ–º–∞—î</p>
                                                {% endfor %}
                                            </div>

                                            <!-- –Ü–Ω–ø—É—Ç –ø—ñ–¥ —Å–ø–∏—Å–∫–æ–º -->
                                            <form method="post" action="/catalog/file/{{ file.pk }}/comment/" class="mt-2 reply-form" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <div class="replying-pill"><span class="replying-to"></span><button type="button" class="replying-clear">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div>
                                                <input type="hidden" name="parent_id" value="" class="reply-parent-input">
                                                <div class="comment-input-bar">
                                                    <textarea name="text" class="form-control comment-textarea" rows="1" placeholder="–î–æ–¥–∞–π—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
                                                    <button type="submit" class="add-comment-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                {% empty %}
                                    <p class="no-files">–ù–µ–º–∞—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤</p>
                                {% endfor %}
                            </div>
                    
                    <!-- –§–æ—Ä–º–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É -->
                            <form method="post" 
                                  enctype="multipart/form-data" 
                                  class="file-upload-form" 
                                  action="{% url 'upload_file' request_obj.id %}">
                        {% csrf_token %}
                                <div class="input-group mb-2 file-upload-group">
                                    <input type="file" 
                                           name="file" 
                                           id="file-input-{{ request_obj.id }}" 
                                           class="form-control file-input" 
                                           required 
                                           onchange="updateFileName(this)">
                                    <label for="file-input-{{ request_obj.id }}" class="file-input-label">–í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</label>
                                    <span id="file-name-{{ request_obj.id }}" class="file-name-label">–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ</span>
                                </div>
                                <div class="input-group mb-2">
                                    <label for="file-description-{{ request_obj.id }}" class="file-description-label">–û–ø–∏—Å —Ñ–∞–π–ª—É (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ):</label>
                                    <textarea id="file-description-{{ request_obj.id }}" name="description" class="form-control file-description-textarea" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —Ñ–∞–π–ª—É..." rows="2"></textarea>
                                </div>
                                <button type="submit" class="file-upload-btn">
                                <i class="fas fa-upload"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                            </button>
                    </form>
                            
                            <script>
                                function updateFileName(input) {
                                    const fileId = input.id.split('-').pop();
                                    const fileNameSpan = document.getElementById(`file-name-${fileId}`);
                                    
                                    if (input.files && input.files[0]) {
                                        fileNameSpan.textContent = input.files[0].name;
                                        fileNameSpan.style.color = '#000000';
                                    } else {
                                        fileNameSpan.textContent = '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
                                        fileNameSpan.style.color = '#6B7280';
                                    }
                                }
                            </script>
                        {% endwith %}
                </div>
            </div>
            {% if user.role == "–°—Ç—É–¥–µ–Ω—Ç" and request_obj.send_contacts %}
                <div class="teacher-contacts" style="margin-top: 15px; padding: 12px; background-color: #f0f4fd; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h4 style="margin-top: 0; margin-bottom: 8px; color: #2563eb; font-size: 16px; font-weight: 600;">
                        <i class="fas fa-address-card" style="margin-right: 5px;"></i> –ö–æ–Ω—Ç–∞–∫—Ç–∏ –≤–∏–∫–ª–∞–¥–∞—á–∞
                    </h4>
                    {% if request_obj.teacher_id.additional_email %}
                        <div style="display: flex; align-items: center; margin-bottom: 5px;">
                            <i class="fas fa-envelope" style="color: #2563eb; margin-right: 8px;"></i>
                            <a href="mailto:{{ request_obj.teacher_id.additional_email }}" style="color: #2563eb; text-decoration: none;">
                                {{ request_obj.teacher_id.additional_email }}
                            </a>
                        </div>
                    {% endif %}
                    {% if request_obj.teacher_id.phone_number %}
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-phone" style="color: #2563eb; margin-right: 8px;"></i>
                            <a href="tel:{{ request_obj.teacher_id.phone_number }}" style="color: #2563eb; text-decoration: none;">
                                {{ request_obj.teacher_id.phone_number }}
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    {% else %}
        {% if is_own_profile %}
            <p class="no-active-works">–£ –≤–∞—Å –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ä–æ–±—ñ—Ç.</p>
        {% else %}
            <p class="no-active-works">–¢—É—Ç –ø—É—Å—Ç–æ.</p>
        {% endif %}
    {% endif %}
    {% elif user.role == "–í–∏–∫–ª–∞–¥–∞—á" %}
    {% csrf_token %}
    <div class="messages"></div>
    {% if active_requests %}
        <h2> üìù –ê–∫—Ç–∏–≤–Ω—ñ —Ä–æ–±–æ—Ç–∏</h2>
        {% for request in active_requests|dictsortreversed:"request_date" %}
            <div class="request-card">
                <div class="request-user">
                    <img src="{% get_profile_picture_url request.student_id %}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    <div class="user-info">
                        <a href="{% url 'profile_detail' request.student_id.id %}" class="profile-link">
                            {{ request.student_id.get_full_name }}
                        </a>
                        <p class="role">{{ request.student_id.role }}</p>
                        <p>–ì—Ä—É–ø–∞: {{ request.student_id.academic_group }}</p>
                        {% if request.custom_student_theme %}
                            <strong>–¢–µ–º–∞:</strong>
                            <p class="theme">{{ request.custom_student_theme }} <span style="color:#888;font-size:0.9em;">(–¥–æ–≤—ñ–ª—å–Ω–∞ —Ç–µ–º–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞)</span></p>
                            {% if user_profile.role == "–í–∏–∫–ª–∞–¥–∞—á" %}
                                <button onclick="showEditThemeModal('{{ request.id }}', '{{ request.custom_student_theme|escapejs }}')" 
                                        class="edit-theme-btn" 
                                        style="display:inline-flex;align-items:center;padding:6px 12px;border-radius:8px;font-size:0.85rem;font-weight:500;box-shadow:0 2px 4px rgba(0,0,0,0.1);background:#6B7280;color:#fff;border:none;cursor:pointer;transition:background 0.2s,box-shadow 0.2s;margin-top:8px;margin-bottom:8px;line-height:1.2;">
                                    <i class="fas fa-edit" style="margin-right:6px;font-size:0.8rem;"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–µ–º—É
                                </button>
                            {% endif %}
                        {% elif request.approved_student_theme %}
                            <strong>–¢–µ–º–∞:</strong>
                            <p class="theme">{{ request.approved_student_theme.theme }} <span style="color:#888;font-size:0.9em;">(–∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–º)</span></p>
                            {% if user_profile.role == "–í–∏–∫–ª–∞–¥–∞—á" %}
                                <button onclick="showEditThemeModal('{{ request.id }}', '{{ request.approved_student_theme.theme|escapejs }}')" 
                                        class="edit-theme-btn" 
                                        style="display:inline-flex;align-items:center;padding:6px 12px;border-radius:8px;font-size:0.85rem;font-weight:500;box-shadow:0 2px 4px rgba(0,0,0,0.1);background:#6B7280;color:#fff;border:none;cursor:pointer;transition:background 0.2s,box-shadow 0.2s;margin-top:8px;margin-bottom:8px;line-height:1.2;">
                                    <i class="fas fa-edit" style="margin-right:6px;font-size:0.8rem;"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–µ–º—É
                                </button>
                            {% endif %}
                        {% elif request.teacher_theme %}
                            <strong>–¢–µ–º–∞:</strong>
                            <p class="theme">{{ request.teacher_theme.theme }}</p>
                            {% if user_profile.role == "–í–∏–∫–ª–∞–¥–∞—á" %}
                                <button onclick="showEditThemeModal('{{ request.id }}', '{{ request.teacher_theme.theme|escapejs }}')" 
                                        class="edit-theme-btn" 
                                        style="display:inline-flex;align-items:center;padding:6px 12px;border-radius:8px;font-size:0.85rem;font-weight:500;box-shadow:0 2px 4px rgba(0,0,0,0.1);background:#6B7280;color:#fff;border:none;cursor:pointer;transition:background 0.2s,box-shadow 0.2s;margin-top:8px;margin-bottom:8px;line-height:1.2;">
                                    <i class="fas fa-edit" style="margin-right:6px;font-size:0.8rem;"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–µ–º—É
                                </button>
                            {% endif %}
                        {% endif %}
                        <strong>–ú–æ—Ç–∏–≤–∞—Ü—ñ—è:</strong>
                        <p class="motivation">{{ request.motivation_text }}</p>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü—ñ—è —Ñ–∞–π–ª—ñ–≤ -->
                <div class="files-section mt-4">
                    {% with files=active_request_files|get_item:request.id %}
                            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–∞–π–ª—ñ–≤ –∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º —É—Å–µ—Ä–µ–¥–∏–Ω—ñ (—è–∫ —É —Å—Ç—É–¥–µ–Ω—Ç–∞) -->
                            <div class="files-scroll-container">
                                <div class="files-header">–§–∞–π–ª–∏</div>
                                {% for file in files %}
                                    <div class="file-block">
                                        <div class="file-header">
                                            <div class="file-title-block">
                                                <div class="file-name file-name-ellipsis">{{ file.get_filename }}</div>
                                                <div class="file-meta">
                                                    <span class="file-owner">{{ file.uploaded_by.get_full_name }}</span>
                                                    <span class="file-dot">¬∑</span>
                                                    <span class="file-role">{{ file.uploaded_by.role }}</span>
                                                    {% if file.uploaded_at %}
                                                    <span class="file-dot">¬∑</span>
                                                    <span class="file-date">{{ file.uploaded_at|date:"Y-m-d H:i" }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="file-actions">
                                                <a href="{% url 'download_file' file.pk %}" class="download-button">
                                                    <i class="fas fa-download download-icon"></i>
                                                    <span>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</span>
                                                </a>
                                                {% if user == file.uploaded_by %}
                                                    <button class="delete-file-btn" data-file-id="{{ file.pk }}" data-url="{% url 'delete_file' file.pk %}">
                                                        <i class="fas fa-trash delete-icon"></i>
                                                        <span>–í–∏–¥–∞–ª–∏—Ç–∏</span>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- –°–µ–∫—Ü—ñ—è –æ–ø–∏—Å—É —Ñ–∞–π–ª—É -->
                                        <div class="file-description-block">
                                            {% if file.description %}
                                                <p class="file-description-text subtle">{{ file.description }}</p>
                                            {% endif %}
                                        </div>

                                        <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ (–æ–±–∏–¥–≤—ñ —Ä–æ–ª—ñ) -->
                                        <div class="file-comments">
                                            <div class="comments-header">
                                                <span>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ ({{ file.comments.count }})</span>
                                            </div>
                                            <div class="comments-list">
                                                {% for comment in file.comments.all %}
                                                    <div class="comment-block {% if comment.author.role == '–í–∏–∫–ª–∞–¥–∞—á' %}teacher-bg{% else %}student-bg{% endif %}" data-comment-id="{{ comment.id }}">
                                                        {% if comment.parent %}
                                                        <!-- –¶–∏—Ç—É–≤–∞–Ω–Ω—è –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ –∫–æ–º–µ–Ω—Ç–∞—Ä—è -->
                                                        <div class="quoted-comment">
                                                            <div class="quoted-comment-header">
                                                                <span class="quoted-author">{{ comment.parent.author.get_full_name }}</span>
                                                                <span class="quoted-date">{{ comment.parent.created_at|date:"d.m.y H:i" }}</span>
                                                            </div>
                                                            <p class="quoted-text">{{ comment.parent.text|truncatechars:100 }}</p>
                                                        </div>
                                                        {% endif %}
                                                        <div class="comment-header">
                                                            <span class="comment-author">{{ comment.author.get_full_name }}</span>
                                                            <span class="comment-date">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                                                        </div>
                                                        <p class="comment-text">{{ comment.text }}</p>
                                                        {% if comment.attachment %}
                                                        <div class="attachment-block">
                                                            <a href="{{ comment.attachment.url }}" download class="attachment-link">
                                                                <i class="fas fa-paperclip attachment-icon"></i>
                                                                <span class="attachment-filename">{{ comment.get_attachment_filename }}</span>
                                                            </a>
                                                        </div>
                                                        {% endif %}
                                                        <div class="comment-actions">
                                                            <button class="reply-btn" type="button" data-parent-id="{{ comment.id }}" data-author="{{ comment.author.get_full_name }}">–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
                                                            {% if user == comment.author %}
                                                            <button class="delete-comment-btn" data-comment-id="{{ comment.id }}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% empty %}
                                                    <p class="no-files" style="margin: 8px 0 0;">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ —â–µ –Ω–µ–º–∞—î</p>
                                                {% endfor %}
                                            </div>

                                            <!-- –Ü–Ω–ø—É—Ç –ø—ñ–¥ —Å–ø–∏—Å–∫–æ–º -->
                                            <form method="post" action="/catalog/file/{{ file.pk }}/comment/" class="mt-2 reply-form" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <div class="replying-pill"><span class="replying-to"></span><button type="button" class="replying-clear">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div>
                                                <input type="hidden" name="parent_id" value="" class="reply-parent-input">
                                                <div class="comment-input-bar">
                                                    <textarea name="text" class="form-control comment-textarea" rows="1" placeholder="–î–æ–¥–∞–π—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
                                                    <button type="submit" class="add-comment-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                {% empty %}
                                    <p class="no-files">–ù–µ–º–∞—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤</p>
                                {% endfor %}
                            </div>

                            <!-- –§–æ—Ä–º–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á–∞ -->
                            <form method="post" 
                                  enctype="multipart/form-data" 
                                  class="file-upload-form"
                                  action="{% url 'upload_file' request.id %}">
                        {% csrf_token %}
                                <div class="input-group mb-2 file-upload-group">
                                    <input type="file" 
                                           name="file" 
                                           id="file-input-{{ request.id }}" 
                                           class="form-control file-input" 
                                           required 
                                           onchange="updateFileName(this)">
                                    <label for="file-input-{{ request.id }}" class="file-input-label">–í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</label>
                                    <span id="file-name-{{ request.id }}" class="file-name-label">–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ</span>
                                </div>
                                <div class="input-group mb-2">
                                    <label for="file-description-{{ request.id }}" class="file-description-label">–û–ø–∏—Å —Ñ–∞–π–ª—É (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ):</label>
                                    <textarea id="file-description-{{ request.id }}" name="description" class="form-control file-description-textarea" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —Ñ–∞–π–ª—É..." rows="2"></textarea>
                                </div>
                                <button type="submit" class="file-upload-btn">
                                <i class="fas fa-upload"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                            </button>
                    </form>
                        {% endwith %}
                </div>

                <!-- Complete button -->
                <div class="actions-container">
                    <div class="action-block">
                        <p>–¶—è –¥—ñ—è —Å–∫–∞—Å—É—î —Ä–æ–±–æ—Ç—É —Ç–∞ –±—É–¥–µ –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–æ—é.

                        </p>
                        <button onclick="showCancelModal('{{ request.id }}')" class="cancel-button">
                            <i class="fas fa-times-circle" style="margin-right: 8px; font-size: 18px;"></i> –°–∫–∞—Å—É–≤–∞—Ç–∏ —Ä–æ–±–æ—Ç—É
                        </button>
                    </div>

                    <div class="action-block align-right">
                        <p>–ü—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–æ–±–æ—Ç—É" –≤–∏ –∑–º–æ–∂–µ—Ç–µ –≤–∏—Å—Ç–∞–≤–∏—Ç–∏ —Ñ—ñ–Ω–∞–ª—å–Ω—É –æ—Ü—ñ–Ω–∫—É —Ç–∞ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ä–æ–±–æ—Ç—É –¥–æ –∞—Ä—Ö—ñ–≤—É.</p>
                        <button onclick="showCompleteModal('{{ request.id }}')" class="complete-button">
                            <i class="fas fa-check-circle" style="margin-right: 8px; font-size: 18px;"></i> –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–æ–±–æ—Ç—É
                        </button>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        {% if is_own_profile %}
            <p class="no-active-works">–£ –≤–∞—Å –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ä–æ–±—ñ—Ç.</p>
        {% else %}
            <p class="no-active-works">–¢—É—Ç –ø—É—Å—Ç–æ.</p>
        {% endif %}
    {% endif %}
{% endif %}
{% endblock %}
</div>

<!-- –î–æ–¥–∞—î–º–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π iframe -->
<iframe name="hidden_upload_frame" id="hidden_upload_frame" style="display:none;"></iframe>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–µ–º–∏ -->
<div id="editThemeModal" class="modal" style="display: none;">
    <div class="edit-theme-modal-content">
        <!-- Updated close button to match completion modal style -->
        <span class="edit-theme-close-modal" onclick="closeEditThemeModal()">&times;</span>
        <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–µ–º—É —Ä–æ–±–æ—Ç–∏</h3>
        <div class="edit-theme-modal-body">
            <form id="editThemeForm">
                <div class="edit-theme-form-group">
                    <textarea id="newTheme" name="newTheme" rows="4" class="edit-theme-form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É —Ç–µ–º—É —Ä–æ–±–æ—Ç–∏..." required></textarea>
                </div>
                <input type="hidden" id="editThemeRequestId" name="requestId">
                <!-- Updated button container and classes to match completion modal -->
                <div class="edit-theme-modal-buttons">
                    <button type="button" class="edit-theme-btn-cancel" onclick="closeEditThemeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="edit-theme-btn-submit">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Cancel modal -->
<div id="cancelModal" class="rejection-modal">
    <div class="rejection-modal-content">
        <button class="rejection-modal-close" onclick="closeCancelModal()">&times;</button>
        <h3 class="rejection-modal-header">–°–∫–∞—Å—É–≤–∞—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É —Ä–æ–±–æ—Ç—É</h3>
        <form id="cancelForm" class="rejection-modal-form" onsubmit="handleCancelSubmit(event)">
            <input type="hidden" id="cancelRequestId" name="requestId">
            <div class="rejection-modal-form-group">
                <textarea id="cancelReason" name="cancelReason" rows="4" class="rejection-modal-textarea" placeholder="–í–∫–∞–∂—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è..."></textarea>
            </div>
            <button type="submit" class="rejection-modal-submit">–°–∫–∞—Å—É–≤–∞—Ç–∏ —Ä–æ–±–æ—Ç—É</button>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

function lockPageScroll(lock) {
  const html = document.documentElement;
  const body = document.body;
  if (lock) {
    html.classList.add('modal-open');
    body.classList.add('modal-open');
  } else {
    html.classList.remove('modal-open');
    body.classList.remove('modal-open');
  }
}    
// –ì–ª–æ–±–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–∑–≤–∏ —Ñ–∞–π–ª—É
function updateFileName(input) {
    const fileId = input.id.split('-').pop();
    const fileNameSpan = document.getElementById(`file-name-${fileId}`);
    
    if (input.files && input.files[0]) {
        fileNameSpan.textContent = input.files[0].name;
        fileNameSpan.style.color = '#000000';
    } else {
        fileNameSpan.textContent = '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
        fileNameSpan.style.color = '#6B7280';
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–∑–≤–∏ —Ñ–∞–π–ª—É –¥–ª—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è
function updateCommentFile(input) {
    // –û—Ç—Ä–∏–º—É—î–º–æ ID —Ñ–∞–π–ª—É –∑ ID –ø–æ–ª—è –≤–≤–æ–¥—É
    var fileId = input.id.replace('comment-file-', '');
    
    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ —Ñ–∞–π–ª—É
    var fileLabel = document.getElementById('file-label-' + fileId);
    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
    var feedback = document.getElementById('attachment-feedback-' + fileId);
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç —Ç–∞ —Å—Ç–∏–ª—ñ
    if (input.files.length > 0) {
        fileLabel.textContent = input.files[0].name;
        fileLabel.style.color = '#000000';
        if (feedback) {
            feedback.style.display = 'block';
        }
    } else {
        fileLabel.textContent = '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
        fileLabel.style.color = '#6B7280';
        if (feedback) {
            feedback.style.display = 'none';
        }
    }
}

$(document).ready(function() {
    $(document).on('click', '.delete-file-btn', function(e) {
        e.preventDefault();
        var button = $(this);
        var url = button.data('url');
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ –≤–ª–∞—Å–Ω–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        var modal = $(`
            <div class="delete-modal">
                <div class="delete-modal-content">
                    <span class="delete-modal-close">&times;</span>
                    <div class="delete-modal-header">
                        <h3 class="delete-modal-title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
                    </div>
                    <p class="delete-modal-message">–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ñ–∞–π–ª?</p>
                    <div class="delete-modal-buttons">
                        <button type="button" class="delete-modal-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="button" class="delete-modal-confirm">OK</button>
                    </div>
                </div>
            </div>
        `);
        
        // –î–æ–¥–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–æ body
        $('body').append(modal).addClass('modal-open');
        $('html').append(modal).addClass('modal-open');
        modal.css('display', 'flex');
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–æ –∫–Ω–æ–ø—Ü—ñ X
        modal.find('.delete-modal-close').click(function() {
            modal.remove();
            $('body').removeClass('modal-open');
            $('html').removeClass('modal-open');
        });
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–∫–∞—Å—É–≤–∞—Ç–∏"
        modal.find('.delete-modal-cancel').click(function() {
            modal.remove();
            $('body').removeClass('modal-open');
            $('html').removeClass('modal-open');
        });
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ "OK"
        modal.find('.delete-modal-confirm').click(function() {
            $.ajax({
                url: url,
                type: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        button.closest('.file-block').fadeOut(300, function() {
                            $(this).remove();
                        });
                    } else {
                        alert('–ü–æ–º–∏–ª–∫–∞: ' + (response.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ñ–∞–π–ª'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ñ–∞–π–ª—É');
                }
            });
            modal.remove();
            $('body').removeClass('modal-open');
            $('html').removeClass('modal-open');
        });
        
        // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ –∫–ª—ñ–∫—É –Ω–∞ —Ñ–æ–Ω
        modal.click(function(e) {
            if ($(e.target).is(modal)) {
                modal.remove();
                $('body').removeClass('modal-open');
                $('html').removeClass('modal-open');
            }
        });
    });

    // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è —Ñ–æ—Ä–º –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —Å—Ç–∞—Ä–∏—Ö —Ñ–æ—Ä–º –±–µ–∑ reply-form)
    $('form[action^="/catalog/file/"][action$="/comment/"]:not(.reply-form)').on('submit', function(e) {
        e.preventDefault();
        
        var form = $(this);
        var fileId = form.attr('action').split('/').slice(-2)[0];
        var textarea = form.find('textarea[name="text"]');
        var commentText = textarea.val().trim();
        var submitBtn = form.find('button[type="submit"]');
        var commentStatus = form.find('.comment-status');
        var sendingStatus = commentStatus.find('.sending-status');
        var successStatus = commentStatus.find('.success-status');
        var fileInput = form.find('input[type="file"]');
        var hasAttachment = (fileInput.length && fileInput[0].files && fileInput[0].files.length > 0) ? true : false;
                
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —Ç–µ–∫—Å—Ç—É –∞–±–æ —Ñ–∞–π–ª—É
        if (!commentText && !hasAttachment) {
            alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –∫–æ–º–µ–Ω—Ç–∞—Ä—è –∞–±–æ –ø—Ä–∏–∫—Ä—ñ–ø—ñ—Ç—å —Ñ–∞–π–ª');
            return;
        }
        
        // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
        commentStatus.show();
        sendingStatus.css('display', 'flex');
        successStatus.hide();
        
        // –î–µ–∞–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É –Ω–∞ —á–∞—Å –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
        submitBtn.prop('disabled', true);
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ FormData –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–∏—Ö, –≤–∫–ª—é—á–∞—é—á–∏ —Ñ–∞–π–ª
        var formData = new FormData(form[0]);
        
        // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            cache: false,
            success: function(response) {
                // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å–ø—ñ—Ö—É
                sendingStatus.hide();
                successStatus.css('display', 'flex');
                
                // –û—á–∏—â–∞—î–º–æ —Ñ–æ—Ä–º—É
                textarea.val('');
                if (hasAttachment) {
                    form.find('input[type="file"]').val('');
                    form.find('#file-label-' + fileId).text('');
                    form.find('#attachment-feedback-' + fileId).hide();
                }
                
                // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É
                setTimeout(function() {
                    location.reload();
                }, 2000);
            },
            error: function(xhr, status, error) {
                // –•–æ–≤–∞—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
                commentStatus.hide();
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É
                try {
                    var errorData = JSON.parse(xhr.responseText);
                    alert('–ü–æ–º–∏–ª–∫–∞: ' + (errorData.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä'));
                } catch (e) {
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—è: ' + error);
                }
            },
            complete: function() {
                // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—É
                submitBtn.prop('disabled', false);
            }
        });
    });

    // –û–±—Ä–æ–±–Ω–∏–∫ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è
    $(document).on('click', '.delete-comment-btn', function() {
        var button = $(this);
        var commentId = button.data('comment-id');
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ –≤–ª–∞—Å–Ω–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –¥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ñ–∞–π–ª—É)
        var modal = $(`
            <div class="delete-modal">
                <div class="delete-modal-content">
                    <span class="delete-modal-close">&times;</span>
                    <div class="delete-modal-header">
                        <h3 class="delete-modal-title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
                    </div>
                    <p class="delete-modal-message">–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–æ–º–µ–Ω—Ç–∞—Ä?</p>
                    <div class="delete-modal-buttons">
                        <button type="button" class="delete-modal-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="button" class="delete-modal-confirm">OK</button>
                    </div>
                </div>
            </div>
        `);
        
        // –î–æ–¥–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–æ body
        $('body').append(modal).addClass('modal-open');
        $('html').append(modal).addClass('modal-open');
        modal.css('display', 'flex');
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–æ –∫–Ω–æ–ø—Ü—ñ X
        modal.find('.delete-modal-close').click(function() {
            modal.remove();
            $('body').removeClass('modal-open');
            $('html').removeClass('modal-open');
        });
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–∫–∞—Å—É–≤–∞—Ç–∏"
        modal.find('.delete-modal-cancel').click(function() {
            modal.remove();
            $('body').removeClass('modal-open');
            $('html').removeClass('modal-open');
        });
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ "OK"
        modal.find('.delete-modal-confirm').click(function() {
            $.ajax({
                url: '/catalog/comment/' + commentId + '/delete/',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        button.closest('.comment-block').fadeOut(300, function() {
                            $(this).remove();
                        });
                    }
                },
                error: function(xhr) {
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—è');
                }
            });
            modal.remove();
            $('body').removeClass('modal-open');
            $('html').removeClass('modal-open');
        });
        
        // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ –∫–ª—ñ–∫—É –Ω–∞ —Ñ–æ–Ω
        modal.click(function(e) {
            if ($(e.target).is(modal)) {
                modal.remove();
                $('body').removeClass('modal-open');
                $('html').removeClass('modal-open');
            }
        });
    });

    // –î–æ–¥–∞—é –æ–±—Ä–æ–±–∫—É —Ñ–æ—Ä–º–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á–∞
    $('.file-upload-form').on('submit', function(e) {
        e.preventDefault();
        var form = this;
        var formData = new FormData(form);
        var requestId = $(form).find('input[type="file"]').attr('id').split('-').pop();
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                form.reset();
                var fileNameSpan = document.getElementById('file-name-' + requestId);
                if (fileNameSpan) {
                    fileNameSpan.textContent = '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
                    fileNameSpan.style.color = '#6B7280';
                }
                if (window.showToast) {
                    window.showToast('–§–∞–π–ª —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ', 'success');
                    setTimeout(() => { location.reload(); }, 1200);
                } else {
                    location.reload();
                }
            } else {
                if (window.showToast) {
                    window.showToast('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ñ–∞–π–ª—É: ' + data.message, 'error');
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ñ–∞–π–ª—É: ' + data.message);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (window.showToast) {
                window.showToast('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ñ–∞–π–ª—É', 'error');
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ñ–∞–π–ª—É');
            }
        });
    });
});

// –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –º–æ–¥–∞–ª—å–Ω–∏–º –≤—ñ–∫–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏
function showCompleteModal(requestId) {
    lockPageScroll(true);
    const modal = document.getElementById('completeModal');
    const gradeInput = document.getElementById('grade');
    const filesSection = document.getElementById('filesSelectionSection');
    const filesCheckboxes = document.getElementById('filesCheckboxes');
    
    // Reset form
    document.getElementById('completeRequestId').value = requestId;
    gradeInput.value = '';
    
    // Clear any previous error messages
    const errorDiv = document.querySelector('.grade-error');
    if (errorDiv) {
        errorDiv.remove();
    }
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ñ–∞–π–ª–∏ –¥–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Ç—É
    loadRequestFiles(requestId, filesCheckboxes, filesSection);
    
    modal.style.display = "flex";
    gradeInput.focus();
}

function loadRequestFiles(requestId, filesCheckboxes, filesSection) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/users/request-files/${requestId}/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.files && data.files.length > 0) {
            filesCheckboxes.innerHTML = '';
            data.files.forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-checkbox-item';
                fileDiv.innerHTML = `
                    <label class="file-checkbox-label">
                        <input type="checkbox" name="selected_files" value="${file.id}" checked id="file_${file.id}">
                        <div class="file-info">
                            <span class="file-name">${file.file_name}</span>
                            <small class="file-meta">(${file.uploaded_at} - ${file.uploaded_by})</small>
                        </div>
                    </label>
                `;
                filesCheckboxes.appendChild(fileDiv);
            });
            filesSection.style.display = 'block';
        } else {
            filesSection.style.display = 'block';
            filesCheckboxes.innerHTML = '<p class="text-muted">–£ —Ü—å–æ–º—É –∑–∞–ø–∏—Ç—ñ –Ω–µ–º–∞—î —Ñ–∞–π–ª—ñ–≤ –¥–ª—è –∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è.</p>';
        }
    })
    .catch(error => {
        console.error('Error loading files:', error);
        filesSection.style.display = 'none';
    });
}

function closeCompleteModal() {
    const modal = document.getElementById('completeModal');
    modal.style.display = "none";
    lockPageScroll(false);
    
    // Clear form and errors
    document.getElementById('completeRequestId').value = '';
    document.getElementById('grade').value = '';
    const errorDiv = document.querySelector('.grade-error');
    if (errorDiv) {
        errorDiv.remove();
    }
}

function validateGrade(grade) {
    // Convert to number and check if it's a valid integer between 0 and 100
    const numGrade = parseInt(grade);
    if (isNaN(numGrade) || numGrade < 0 || numGrade > 100 || !Number.isInteger(numGrade)) {
        return false;
    }
    return true;
}

function showError(message) {
    // Remove any existing error message
    const existingError = document.querySelector('.grade-error');
    if (existingError) {
        existingError.remove();
    }
    
    // Create and show new error message
    const errorDiv = document.createElement('div');
    errorDiv.className = 'grade-error alert alert-danger mt-2';
    errorDiv.textContent = message;
    
    const gradeInput = document.getElementById('grade');
    gradeInput.parentNode.insertBefore(errorDiv, gradeInput.nextSibling);
}

function submitComplete() {
    const requestId = document.getElementById('completeRequestId').value;
    const grade = document.getElementById('grade').value.trim();
    
    // Validate grade
    if (!grade) {
        showError('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –æ—Ü—ñ–Ω–∫—É');
        return;
    }
    
    if (!validateGrade(grade)) {
        showError('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ü—ñ–ª–µ —á–∏—Å–ª–æ –≤—ñ–¥ 0 –¥–æ 100');
        return;
    }

    // Get selected files
    const checkboxes = document.querySelectorAll('input[name="selected_files"]');
    const checkedBoxes = document.querySelectorAll('input[name="selected_files"]:checked');
    
    const selectedFiles = Array.from(checkedBoxes).map(checkbox => checkbox.value);
        
    // Check if files are selected
    if (selectedFiles.length === 0) {
        showError('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ñ–∞–π–ª –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –∞—Ä—Ö—ñ–≤—ñ');
        return;
    }

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Show loading state
    const submitBtn = document.querySelector('#completeModal .btn-submit');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

    // Prepare data
    const formData = new FormData();
    formData.append('grade', grade);
    formData.append('selected_files', JSON.stringify(selectedFiles));
    
    // Send request to server
    fetch(`/users/complete_request/${requestId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        return response.json().then(data => {
            if (!response.ok) {
                throw new Error(data.error || `HTTP error! status: ${response.status}`);
            }
            return data;
        });
    })
    .then(data => {
        if (data.success) {
            // Close modal and reload page
            closeCompleteModal();
            window.location.reload();
        } else {
            // –¶–µ–π –±–ª–æ–∫ –º–æ–∂–µ –±—É—Ç–∏ –∑–∞–π–≤–∏–º, –∞–ª–µ –∑–∞–ª–∏—à–∞—î–º–æ –¥–ª—è –±–µ–∑–ø–µ–∫–∏
            throw new Error(data.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–æ–±–æ—Ç—É');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError(error.message);
        
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
}

// Add event listeners when document is ready
document.addEventListener('DOMContentLoaded', function() {
    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeCompleteModal();
        }
    });
    
    // Handle grade input validation
    const gradeInput = document.getElementById('grade');
    if (gradeInput) {
        gradeInput.addEventListener('input', function() {
            const errorDiv = document.querySelector('.grade-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            // Remove non-numeric characters
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // Validate as user types
            if (this.value && !validateGrade(this.value)) {
                showError('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ü—ñ–ª–µ —á–∏—Å–ª–æ –≤—ñ–¥ 0 –¥–æ 100');
            }
        });
        
        // Handle form submission with Enter key
        gradeInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitComplete();
            }
        });
    }
});
</script>

<script>
// –î–∏–Ω–∞–º—ñ—á–Ω–∞ –≤–∏—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ñ–∞–π–ª—ñ–≤: –ø–æ–∫–∞–∑—É—î —Ä—ñ–≤–Ω–æ –æ–¥–∏–Ω —Ñ–∞–π–ª (–∑ –æ–ø–∏—Å–æ–º —ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏)
function setFilesContainersHeight() {
    const containers = document.querySelectorAll('.files-scroll-container');
    containers.forEach(container => {
        const firstBlock = container.querySelector('.file-block');
        if (!firstBlock) {
            container.style.removeProperty('--files-container-max');
            return;
        }
        const header = container.querySelector('.files-header');
        const containerStyles = getComputedStyle(container);
        const paddingTop = parseFloat(containerStyles.paddingTop) || 0;
        const paddingBottom = parseFloat(containerStyles.paddingBottom) || 0;

        const blockStyles = getComputedStyle(firstBlock);
        const marginTop = parseFloat(blockStyles.marginTop) || 0;
        const marginBottom = parseFloat(blockStyles.marginBottom) || 0;
        const blockOuter = firstBlock.offsetHeight + marginTop + marginBottom;
        const headerHeight = header ? header.offsetHeight : 0;
        const total = blockOuter + headerHeight + paddingTop + paddingBottom;
        container.style.setProperty('--files-container-max', `${Math.ceil(total)}px`);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    setFilesContainersHeight();
});

window.addEventListener('load', setFilesContainersHeight);
window.addEventListener('resize', setFilesContainersHeight);

// –î–æ–¥–∞—Ç–∫–æ–≤–æ: —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—î–º–æ –∑–∞ –∑–º—ñ–Ω–∞–º–∏ —Ä–æ–∑–º—ñ—Ä—É –ø–µ—Ä—à–æ–≥–æ –±–ª–æ–∫—É (–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ)
const filesResizeObservers = [];
function observeFilesContainers() {
    const containers = document.querySelectorAll('.files-scroll-container');
    containers.forEach(container => {
        const firstBlock = container.querySelector('.file-block');
        if (!firstBlock || firstBlock._resizeObserved) return;

        const ro = new ResizeObserver(() => setFilesContainersHeight());
        ro.observe(firstBlock);
        filesResizeObservers.push(ro);

        // –ù–∞ –≤–∏–ø–∞–¥–æ–∫ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —É—Å–µ—Ä–µ–¥–∏–Ω—ñ (MutationObserver)
        const mo = new MutationObserver(() => setFilesContainersHeight());
        mo.observe(firstBlock, { childList: true, subtree: true });
        filesResizeObservers.push(mo);

        firstBlock._resizeObserved = true;
    });
}

document.addEventListener('DOMContentLoaded', observeFilesContainers);
window.addEventListener('load', observeFilesContainers);
</script>

<script>
// –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–µ–º–∏
function showEditThemeModal(requestId, currentTheme) {
    lockPageScroll(true);
    document.getElementById('editThemeRequestId').value = requestId;
    document.getElementById('newTheme').value = currentTheme;
    document.getElementById('editThemeModal').style.display = 'flex';
}

function closeEditThemeModal() {
    lockPageScroll(false);
    document.getElementById('editThemeModal').style.display = 'none';
    document.getElementById('editThemeForm').reset();
}

document.addEventListener('DOMContentLoaded', function() {
    const editThemeForm = document.getElementById('editThemeForm');
    if (editThemeForm) {
        editThemeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const requestId = document.getElementById('editThemeRequestId').value;
            const newTheme = document.getElementById('newTheme').value.trim();
            
            if (!newTheme) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É —Ç–µ–º—É');
                return;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Show loading state - –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–µ–ª–µ–∫—Ç–æ—Ä
            const submitBtn = document.querySelector('#editThemeForm .edit-theme-btn-submit');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
            
            // Send request to server
            fetch(`/users/edit-request-theme/${requestId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    new_theme: newTheme
                })
            })
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                if (data.success) {
                    // Close modal and reload page
                    closeEditThemeModal();
                    window.location.reload();
                } else {
                    throw new Error(data.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ç–µ–º—É');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
                
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeEditThemeModal();
        }
    });
});

function showCancelModal(requestId) {
    lockPageScroll(true);
    const modal = document.getElementById('cancelModal');
    document.getElementById('cancelRequestId').value = requestId;
    modal.style.display = 'flex';
}

function closeCancelModal() {
    lockPageScroll(false);
    const modal = document.getElementById('cancelModal');
    modal.style.display = 'none';
    document.getElementById('cancelForm').reset();
}

function handleCancelSubmit(event) {
    event.preventDefault();
    
    const form = event.target;
    const requestId = form.querySelector('#cancelRequestId').value;
    const reason = form.querySelector('#cancelReason').value.trim();
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;


    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '–°–∫–∞—Å—É–≤–∞–Ω–Ω—è...';

fetch(`/users/cancel-request/${requestId}/`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
    },
    body: `rejected_reason=${encodeURIComponent(reason)}`
})
.then(response => response.json().then(data => {
    if (!response.ok) {
        throw new Error(data.error || `HTTP error! status: ${response.status}`);
    }
    return data;
}))
.then(data => {
    if (data.success) {
        closeCancelModal();
        window.location.reload();
    } else {
        alert(data.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ä–æ–±–æ—Ç—É.');
    }
})
.catch(error => {
    alert(error.message || '–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
})
.finally(() => {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
});
}
</script>
