{% load static %}

<link rel="stylesheet" href="{% static 'css/modal.css' %}">

{% if user_profile.role == "–°—Ç—É–¥–µ–Ω—Ç" %}
    {% if archived_requests %}
        <h2>üìÇ –ê—Ä—Ö—ñ–≤ —Ä–æ–±—ñ—Ç</h2>
        {% for request in archived_requests|dictsortreversed:"completion_date" %}
            <div class="request-card archived-request-card" data-request-id="{{ request.id }}" style="cursor: pointer;">
                <div class="request-user">
                    {% if request.teacher_id.teacher_id.profile_picture %}
                        <img src="{{ request.teacher_id.teacher_id.profile_picture.url }}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    {% else %}
                        <img src="{% static 'images/default-avatar.jpg' %}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    {% endif %}
                    <div class="user-info">
                        <h3>{{ request.teacher_id.teacher_id.get_full_name }}</h3>
                        <p class="role">{{ request.teacher_id.academic_level }}</p>
                        {% if request.teacher_theme %}
                            <strong>–¢–µ–º–∞ —Ä–æ–±–æ—Ç–∏:</strong>
                            <p class="theme">{{ request.teacher_theme.theme }}</p>
                        {% endif %}
                        <strong>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è:</strong>
                        <p>{{ request.completion_date|date:"d.m.Y" }}</p>
                        <strong>–û—Ü—ñ–Ω–∫–∞:</strong>
                        <p class="grade">{{ request.grade }}/100</p>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="no-active-works">–£ –≤–∞—Å –Ω–µ–º–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö —Ä–æ–±—ñ—Ç.</p>
    {% endif %}

{% elif user_profile.role == "–í–∏–∫–ª–∞–¥–∞—á" %}
    {% if archived_requests %}
        <h2>üìÇ –ê—Ä—Ö—ñ–≤ —Ä–æ–±—ñ—Ç</h2>
        {% for request in archived_requests|dictsortreversed:"completion_date" %}
            <div class="request-card archived-request-card" data-request-id="{{ request.id }}" style="cursor: pointer;">
                <div class="request-user">
                    {% if request.student_id.profile_picture %}
                        <img src="{{ request.student_id.profile_picture.url }}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    {% else %}
                        <img src="{% static 'images/default-avatar.jpg' %}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    {% endif %}
                    <div class="user-info">
                        <h3>{{ request.student_id.get_full_name }}</h3>
                        <p class="role">{{ request.student_id.academic_group }}</p>
                        {% if request.teacher_theme %}
                            <strong>–¢–µ–º–∞ —Ä–æ–±–æ—Ç–∏:</strong>
                            <p class="theme">{{ request.teacher_theme.theme }}</p>
                        {% endif %}
                        <strong>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è:</strong>
                        <p>{{ request.completion_date|date:"d.m.Y" }}</p>
                        <strong>–û—Ü—ñ–Ω–∫–∞:</strong>
                        <p class="grade">{{ request.grade }}/100</p>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="no-active-works">–£ –≤–∞—Å –Ω–µ–º–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö —Ä–æ–±—ñ—Ç.</p>
    {% endif %}
{% endif %} 

<!-- Modal for Archived Request Details -->
<div id="archivedRequestModal" class="modal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div id="archivedRequestDetails">
            <!-- Content will be injected by JavaScript -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('archivedRequestModal');
    const closeBtn = modal.querySelector('.close-modal');
    const detailsContainer = document.getElementById('archivedRequestDetails');

    document.querySelectorAll('.archived-request-card').forEach(card => {
        card.addEventListener('click', function() {
            const requestId = this.dataset.requestId;
            fetch(`/catalog/archived-request-details/${requestId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error fetching archived request details:', data.error);
                    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–µ—Ç–∞–ª—ñ —Ä–æ–±–æ—Ç–∏.');
                    return;
                }

                let filesHtml = '<h4>–§–∞–π–ª–∏ —Ä–æ–±–æ—Ç–∏</h4>';
                if (data.files && data.files.length > 0) {
                    filesHtml += '<ul class="archived-files-list">';
                    data.files.forEach(file => {
                        filesHtml += `<li class="archived-file-card">
                            <p><a href="${file.file_url}" target="_blank" download>${file.file_name}</a></p>
                            <div class="archived-file-meta">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏–≤: ${file.uploaded_by} (${file.uploaded_at})</div>
                            <div class="archived-file-description">–û–ø–∏—Å: ${file.description || '–Ω–µ–º–∞—î'}</div>`;
                        if(file.comments && file.comments.length > 0) {
                            filesHtml += '<div><strong>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ:</strong><ul class="archived-comments-list">';
                            file.comments.forEach(comment => {
                                filesHtml += `<li class="archived-comment">
                                    <strong>${comment.author}:</strong> ${comment.text}
                                    <span class="comment-date">${comment.created_at}</span>
                                </li>`;
                            });
                            filesHtml += '</ul></div>';
                        }
                        filesHtml += '</li>';
                    });
                    filesHtml += '</ul>';
                } else {
                    filesHtml += '<p>–§–∞–π–ª—ñ–≤ –Ω–µ –±—É–ª–æ –¥–æ–¥–∞–Ω–æ.</p>';
                }

                detailsContainer.innerHTML = `
                    <h3>–î–µ—Ç–∞–ª—ñ –∑–∞–≤–µ—Ä—à–µ–Ω–æ—ó —Ä–æ–±–æ—Ç–∏</h3>
                    <p><strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> ${data.student.name} (${data.student.group})</p>
                    <p><strong>–í–∏–∫–ª–∞–¥–∞—á:</strong> ${data.teacher.name}</p>
                    <p><strong>–¢–µ–º–∞:</strong> ${data.theme}</p>
                    <p><strong>–ü—ñ–¥—Å—É–º–∫–æ–≤–∞ –æ—Ü—ñ–Ω–∫–∞:</strong> ${data.grade}/100</p>
                    <p><strong>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è:</strong> ${data.completion_date}</p>
                    <hr>
                    ${filesHtml}
                `;

                modal.style.display = 'block';
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
            });
        });
    });

    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
});
</script> 