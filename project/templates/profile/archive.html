{% load static %}
{% load catalog_extras %}

{% csrf_token %}

<!-- Add CSS link -->
<link rel="stylesheet" href="{% static 'css/archive-modal.css' %}">

{% if user_profile.role == "–°—Ç—É–¥–µ–Ω—Ç" %}
    {% if archived_requests %}
        <h2>üìÇ –ê—Ä—Ö—ñ–≤ —Ä–æ–±—ñ—Ç</h2>
        {% for request in archived_requests|dictsortreversed:"completion_date" %}
            {% if request.student_id.id == user_profile.id %}
            <div class="request-card archived-request-card" data-request-id="{{ request.id }}" style="cursor: pointer;">
                <div class="request-user">
                    <img src="{% get_profile_picture_url request.teacher_id.teacher_id %}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    <div class="user-info">
                        <h3>{{ request.teacher_id.teacher_id.get_full_name }}</h3>
                        <p class="role">{{ request.teacher_id.academic_level }}</p>
                        <strong>–¢–µ–º–∞ —Ä–æ–±–æ—Ç–∏:</strong>
                        <p class="theme">{{ request.theme_display }}</p>
                        <strong>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è:</strong>
                        <p>{{ request.completion_date|date:"d.m.Y" }}</p>
                        <strong>–û—Ü—ñ–Ω–∫–∞:</strong>
                        <p class="grade">{{ request.grade }}/100</p>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    {% else %}
        {% if is_own_profile %}
            <p class="no-active-works">–£ –≤–∞—Å –Ω–µ–º–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö —Ä–æ–±—ñ—Ç.</p>
        {% else %}
            <p class="no-active-works">–¢—É—Ç –ø—É—Å—Ç–æ.</p>
        {% endif %}
    {% endif %}

{% elif user_profile.role == "–í–∏–∫–ª–∞–¥–∞—á" %}
    {% if archived_requests %}
        <h2>üìÇ –ê—Ä—Ö—ñ–≤ —Ä–æ–±—ñ—Ç</h2>
        {% for request in archived_requests|dictsortreversed:"completion_date" %}
            {% if request.teacher_id.teacher_id.id == user_profile.id %}
            <div class="request-card archived-request-card" data-request-id="{{ request.id }}" style="cursor: pointer;">
                <div class="request-user">
                    <img src="{% get_profile_picture_url request.student_id %}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    <div class="user-info">
                        <h3>{{ request.student_id.get_full_name }}</h3>
                        <p class="role">{{ request.student_id.academic_group }}</p>
                        <strong>–¢–µ–º–∞ —Ä–æ–±–æ—Ç–∏:</strong>
                        <p class="theme">{{ request.theme_display }}</p>
                        <strong>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è:</strong>
                        <p>{{ request.completion_date|date:"d.m.Y" }}</p>
                        <strong>–û—Ü—ñ–Ω–∫–∞:</strong>
                        <p class="grade">{{ request.grade }}/100</p>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    {% else %}
        {% if is_own_profile %}
            <p class="no-active-works">–£ –≤–∞—Å –Ω–µ–º–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö —Ä–æ–±—ñ—Ç.</p>
        {% else %}
            <p class="no-active-works">–¢—É—Ç –ø—É—Å—Ç–æ.</p>
        {% endif %}
    {% endif %}
{% endif %} 

<!-- Modal for Archived Request Details -->
<div id="archivedRequestModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div id="archivedRequestDetails">
            <!-- Content will be injected by JavaScript -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('archivedRequestModal');
    const closeBtn = modal.querySelector('.close-modal');
    const detailsContainer = document.getElementById('archivedRequestDetails');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.querySelectorAll('.archived-request-card').forEach(card => {
        card.addEventListener('click', function() {
            const requestId = this.dataset.requestId;
            fetch(`/users/archived-request-details/${requestId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {                
                if (data.error) {
                    console.error('Error fetching archived request details:', data.error);
                    if (data.error === 'Forbidden') {
                        alert('–£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ü—ñ—î—ó —Ä–æ–±–æ—Ç–∏.');
                    } else if (data.error === 'Request not found') {
                        alert('–†–æ–±–æ—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ú–æ–∂–ª–∏–≤–æ, —ó—ó –≤–∂–µ –≤–∏–¥–∞–ª–µ–Ω–æ –∞–±–æ –≤–æ–Ω–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.');
                    } else {
                        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–µ—Ç–∞–ª—ñ —Ä–æ–±–æ—Ç–∏.');
                    }
                    return;
                }

                let filesHtml = '<h4>–§–∞–π–ª–∏ —Ä–æ–±–æ—Ç–∏</h4>';
                if (data.files && data.files.length > 0) {
                    filesHtml += '<ul>';
                    data.files.forEach(file => {
                        filesHtml += `<li>
                            <div class="file-info">
                                <p><strong><a href="${file.file_url}" target="_blank" download>${file.file_name}</a></strong></p>
                                <div class="file-meta">
                                    <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏–≤: ${file.uploaded_by}</p>
                                    <p>${file.uploaded_at}</p>
                                </div>
                            </div>
                            <p class="file-description">–û–ø–∏—Å: ${file.description || '–Ω–µ–º–∞—î'}</p>`;
                        
                        if(file.comments && file.comments.length > 0) {
                            filesHtml += '<h5>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ:</h5><div class="comments-list">';
                            file.comments.forEach(comment => {
                                filesHtml += `<li>
                                    <strong>${comment.author}:</strong> ${comment.text} 
                                    <span style="float: right;">${comment.created_at}</span>
                                </li>`;
                            });
                            filesHtml += '</div>';
                        }
                        filesHtml += '</li>';
                    });
                    filesHtml += '</ul>';
                } else {
                    filesHtml += '<p>–§–∞–π–ª—ñ–≤ –Ω–µ –±—É–ª–æ –¥–æ–¥–∞–Ω–æ.</p>';
                }

                detailsContainer.innerHTML = `
                    <h3>–î–µ—Ç–∞–ª—ñ –∑–∞–≤–µ—Ä—à–µ–Ω–æ—ó —Ä–æ–±–æ—Ç–∏</h3>
                    <div class="highlight">
                        <p><strong>–ü—ñ–¥—Å—É–º–∫–æ–≤–∞ –æ—Ü—ñ–Ω–∫–∞:</strong> ${data.grade}/100</p>
                        <p><strong>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è:</strong> ${data.completion_date}</p>
                    </div>
                    <p><strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> ${data.student.name} (${data.student.group})</p>
                    <p><strong>–í–∏–∫–ª–∞–¥–∞—á:</strong> ${data.teacher.name}</p>
                    <p><strong>–¢–µ–º–∞:</strong> ${data.theme}</p>
                    <hr>
                    ${filesHtml}
                `;

                modal.style.display = 'block';
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
            });
        });
    });

    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
});
</script> 