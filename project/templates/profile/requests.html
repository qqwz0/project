{% load static %}

{% if user_profile.role == "–°—Ç—É–¥–µ–Ω—Ç" %}
    {% if sent_requests %}
        <h2>üì© –ù–∞–¥—ñ—Å–ª–∞–Ω—ñ –∑–∞–ø–∏—Ç–∏</h2>
        {% for request in sent_requests|dictsortreversed:"request_date" %}
            <div class="request-card">
                <div class="request-user">
                    {% if user.profile.profile_picture %}
                        <img src="{{ request.teacher_id.teacher_id.profile_picture }}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="default-avatar">
                    {% else %}
                        <img src="{% static 'images/default-avatar.jpg' %}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    {% endif %}
                    <div class="user-info">
                        <a href="{% url 'profile_detail' request.teacher_id.teacher_id.id %}" class="profile-link">
                            {{ request.teacher_id.teacher_id.get_full_name }}
                        </a>
                        <p class="role">{{ request.teacher_id.teacher_id.role }}</p>
                        {% if request.teacher_theme %}
                            <strong>–¢–µ–º–∞ –≤–∏–∫–ª–∞–¥–∞—á–∞:</strong>
                            <p class="theme">{{ request.teacher_theme.theme }}</p>
                        {% endif %}
                        {% if request.student_themes.all %}
                            <strong>–¢–µ–º–∞—Ç–∏–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞:</strong>
                            <ul style="list-style-type: none">
                                {% for theme in request.student_themes.all %}
                                    <li>{{ theme.theme }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        <strong>–ú–æ—Ç–∏–≤–∞—Ü—ñ—è:</strong>
                        <p class="motivation">{{ request.motivation_text }}</p>
                    </div>
                </div>
                <span class="status {{ request.request_status }}">{{ request.get_request_status_display }}</span>
            </div>
        {% endfor %}
    {% else %}
        <p>–í–∏ —â–µ –Ω–µ –Ω–∞–¥—Å–∏–ª–∞–ª–∏ –∑–∞–ø–∏—Ç—ñ–≤.</p>
    {% endif %}


    {% elif user_profile.role == "–í–∏–∫–ª–∞–¥–∞—á" %}
    {% if received_requests %}
        <h2>üì• –û—Ç—Ä–∏–º–∞–Ω—ñ –∑–∞–ø–∏—Ç–∏</h2>
        {% for request in received_requests|dictsortreversed:"request_date" %}
            <div class="request-card">
                <div class="request-user">
                    {% if request.student_id.profile_picture %}
                        <img src="{{ request.student_id.profile_picture.url }}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    {% else %}
                        <img src="{% static 'images/default-avatar.jpg' %}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" class="request-avatar">
                    {% endif %}
                    <div class="user-info">
                        <h3>{{ request.student_id.get_full_name }}</h3>
                        <p class="role">{{ request.student_id.academic_group }}</p>

                        {% if request.teacher_theme %}
                            <strong>–ó–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∞ —Ç–µ–º–∞:</strong>
                            <p class="theme">{{ request.teacher_theme.theme }}</p>
                        {% endif %}

                        <strong>–¢–µ–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞:</strong>
                        {% if request.student_themes.all %}
                            <ul style="list-style-type: none">
                                {% for theme in request.student_themes.all %}
                                    <li>{{ theme.theme }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}

                        <strong>–ú–æ—Ç–∏–≤–∞—Ü—ñ—è:</strong>
                        <p class="motivation">{{ request.motivation_text }}</p>
                    </div>
                </div>

                <!-- Buttons for approval/decline -->
                <div class="request-actions">
                    <form method="post" action="{% url 'approve_request' request.id %}">
                        {% csrf_token %}
                        <button type="submit" class="request-button accept">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                    </form>
                    <button type="button" class="request-button reject" onclick="openRejectModal({{ request.id }})">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>  <!-- Just open the modal for the specific request -->
                </div>

                <!-- Rejection Reason Modal (unique per request) -->
                <div id="rejectModal-{{ request.id }}" class="modal">
                    <div class="modal-content">
                        <div style='display: flex; justify-content: space-between; align-items: center;'>
                            <h3>–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –∑–∞–ø–∏—Ç</h3>
                            <i class="fas fa-times close-modal" onclick="closeModal({{ request.id }})" ></i> <!-- Font Awesome cross icon -->
                        </div>
                        <form id="reject-form-{{ request.id }}" action="{% url 'reject_request' request.id %}" method="POST">
                            {% csrf_token %}
                            <label for="reason">–ü—Ä–∏—á–∏–Ω–∞:</label>
                            <textarea id="reason" name="reason" rows="4" required></textarea>
                            <div class="modal-buttons">
                                <!-- Second button inside the modal triggers form submission -->
                                <button type="submit" class='request-button reject'>–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>–£ –≤–∞—Å –Ω–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤.</p>
    {% endif %}
{% endif %}




{% block scripts %}
<script>
    function loadTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById(tabName + '-section').style.display = 'block';

        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }

        // Show the modal for the specific request
    function openRejectModal(requestId) {
        document.getElementById("rejectModal-" + requestId).style.display = "flex";
    }

    // Close the modal for the specific request
    function closeModal(requestId) {
        document.getElementById("rejectModal-" + requestId).style.display = "none";
    }

    // Optionally: Add event listeners for dynamically added reject buttons
    document.addEventListener("DOMContentLoaded", function () {
        const rejectButtons = document.querySelectorAll(".reject-button");
        
        rejectButtons.forEach(button => {
            button.addEventListener("click", function () {
                const requestId = this.getAttribute("data-request-id");
                openRejectModal(requestId);
            });
        });
    });
</script>
{% endblock %}
