{% extends "profile/profile-page.html" %}
{% load static %}
{% load catalog_extras %}

{% block content %}
<div class="edit-profile-container">
    <div class="edit-profile-header">
        <div class="profile-image">
            <img src="{% get_profile_picture_url user_profile %}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" id="profile-preview">
        </div>
        <div class="profile-title">
            <h1>{{ user.get_full_name }}</h1>
            <p class="email">{{ user.email }}</p>
        </div>
    </div>

    <h2 class="edit-title">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>

    {% if messages %}
    <div class="messages" id="django-messages">
        {% for message in messages %}
            <div class="message {{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="form-content">
        <form method="post" class="edit-form" id="teacherProfileForm" enctype="multipart/form-data">
            {% csrf_token %}
    
            <div class="form-sections teacher-sections">
                <!-- LEFT COLUMN: –û—Å–æ–±–∏—Å—Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è + –ú—ñ—Å—Ü—è -->
                <div>
                  <div class="personal-info">
                    <h3>–û—Å–æ–±–∏—Å—Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="{{ form.first_name.id_for_label }}">–Ü–º'—è</label>
                        {{ form.first_name }}
                        <div class="error-message" id="first_name-error"></div>
                      </div>
                      <div class="form-group">
                        <label for="{{ form.patronymic.id_for_label }}">–ü–æ-–±–∞—Ç—å–∫–æ–≤—ñ</label>
                        {{ form.patronymic }}
                        <div class="error-message" id="patronymic-error"></div>
                      </div>
                    </div>
                    <div class="form-group full-width">
                      <label for="{{ form.last_name.id_for_label }}">–ü—Ä—ñ–∑–≤–∏—â–µ</label>
                      {{ form.last_name }}
                      <div class="error-message" id="last_name-error"></div>
                    </div>
                    <div class="form-group full-width">
                      <label for="{{ form.department.id_for_label }}">–ö–∞—Ñ–µ–¥—Ä–∞</label>
                      {{ form.department }}
                      <div class="error-message" id="department-error"></div>
                    </div>
                    <div class="form-group full-width">
                      <label for="{{ form.academic_level.id_for_label }}">–ù–∞—É–∫–æ–≤–∏–π —Ä—ñ–≤–µ–Ω—å</label>
                      {{ form.academic_level }}
                      <div class="error-message" id="academic_level-error"></div>
                    </div>
                  </div>
                  <!-- –ú—ñ—Å—Ü—è -->
                  <!-- –ó–ê–ö–û–ú–ï–ù–¢–û–í–ê–ù–û: —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –∑–º—ñ–Ω–∏ –∫–≤–æ—Ç (–±—É–¥–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ–∑–Ω—ñ—à–µ)
                  <div class="quota-section">
                    <h3>–ú—ñ—Å—Ü—è</h3>
                    {% for slot in slots %}
                    <div class="form-row slot-row">
                      <div class="form-group">
                        <label>–ö–≤–æ—Ç–∞</label>
                        <input type="number" 
                               name="quota_{{ slot.stream_id.id }}" 
                               value="{{ slot.quota }}" 
                               min="0" 
                               class="quota-input"
                               data-stream="{{ slot.stream_id.id }}">
                      </div>
                      <div class="form-group">
                        <label>–ü–æ—Ç—ñ–∫</label>
                        <input type="text" 
                               value="{{ slot.stream_id.stream_code }}" 
                               readonly 
                               class="stream-input">
                      </div>
                    </div>
                    {% endfor %}
                    <button type="button" id="addStreamBtn" class="add-stream-btn">
                      <i class="fas fa-plus"></i> <span>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –ø–æ—Ç—ñ–∫</span>
                    </button>
                  </div>

                   
                  <div id="streamModal" class="modal">
                    <div class="modal-content">
                      <span class="close-modal" onclick="closeStreamModal()">&times;</span>
                      <h3>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –ø–æ—Ç—ñ–∫</h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label for="streamSelect">–í–∏–±–µ—Ä—ñ—Ç—å –ø–æ—Ç—ñ–∫:</label>
                          <select id="streamSelect" class="form-control">
                            {% for stream in available_streams %}
                            <option value="{{ stream.id }}">{{ stream.stream_code }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="form-group">
                          <label for="newQuota">–ö–≤–æ—Ç–∞:</label>
                          <input type="number" id="newQuota" min="0" value="0" class="form-control">
                        </div>
                      </div>
                      <button type="button" onclick="saveNewStream()" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                  </div>
                  -->
                </div>
                <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≤–∏–±–æ—Ä—É –ø–æ—Ç–æ–∫—É -->
                <!-- RIGHT COLUMN: –ö–æ–Ω—Ç–∞–∫—Ç–∏ + –¢–µ–º–∏ -->
                <div>
                  <div class="contacts">
                    <h3>–ö–æ–Ω—Ç–∞–∫—Ç–∏</h3>
                    <div class="form-group">
                      <label for="{{ form.additional_email.id_for_label }}">–î–æ–¥–∞—Ç–∫–æ–≤–∞ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ —Å–∫—Ä–∏–Ω—å–∫–∞</label>
                      {{ form.additional_email }}
                      <div class="error-message" id="additional_email-error"></div>
                    </div>
                    <div class="form-group phone-group">
                      <label for="{{ form.phone_number.id_for_label }}">–†–æ–±–æ—á–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label>
                      <div class="phone-input">
                        <span class="country-code">+380</span>
                        {{ form.phone_number }}
                      </div>
                      <div class="error-message" id="phone_number-error"></div>
                    </div>
                  </div>
                <!-- –¢–ï–ú–ò -->
                  <div class="themes-section">
                    <h3>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ–º–∞–º–∏ —Ä–æ–±—ñ—Ç</h3>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ—ó —Ç–µ–º–∏ -->
                    <div class="add-theme-container">
                        <button type="button" class="add-theme-btn" onclick="addNewTheme()">
                            <i class="plus-icon">+</i>
                            –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É —Ç–µ–º—É
                        </button>
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç–æ–∫ —Ç–µ–º -->
                    <div id="themes-grid" class="themes-grid">
                        {% for theme in existing_themes %}
                        <div class="theme-card" data-theme-id="{{ theme.id }}" data-active="{{ theme.is_active|yesno:'true,false' }}">
                            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º–∏ -->
                            <div class="theme-title-container">
                                <h4 class="theme-title" title="{{ theme.theme }}">{{ theme.theme }}</h4>
                            </div>
                            
                            <!-- –°—Ç–∞—Ç—É—Å —Ç–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ -->
                            <div class="theme-status-container">
                                <div class="status-indicator {% if theme.is_active and not theme.is_deleted %}active{% else %}inactive{% endif %}">
                                    <span class="status-dot"></span>
                                    <span class="status-text">{% if theme.is_active and not theme.is_deleted %}–ê–∫—Ç–∏–≤–Ω–∞{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω–∞{% endif %}</span>
                                </div>
                                <div class="requests-count">
                                    –ó–∞–ø–∏—Ç—ñ–≤: {{ theme.get_active_requests_count }}
                                </div>
                            </div>
                            
                            <!-- –û–ø–∏—Å —Ç–µ–º–∏ -->
                            {% if theme.theme_description %}
                            <div class="theme-description">
                                {{ theme.theme_description|truncatechars:120 }}
                            </div>
                            {% endif %}
                            
                            <!-- –ü–æ—Ç–æ–∫–∏ -->
                            <div class="theme-streams-container">
                                <label class="streams-label">–ü–æ—Ç–æ–∫–∏:</label>
                                <div class="streams-list" data-theme-id="{{ theme.id }}">
                                    {% for stream in theme.streams.all %}
                                        <div class="stream-item">
                                            <input type="checkbox" id="stream-{{ theme.id }}-{{ stream.id }}" 
                                                   value="{{ stream.id }}" checked 
                                                   onchange="updateThemeStreams({{ theme.id }})">
                                            <label for="stream-{{ theme.id }}-{{ stream.id }}">{{ stream.stream_code }}</label>
                                        </div>
                                    {% endfor %}
                                    {% for stream in all_streams %}
                                        {% if stream not in theme.streams.all %}
                                        <div class="stream-item">
                                            <input type="checkbox" id="stream-{{ theme.id }}-{{ stream.id }}" 
                                                   value="{{ stream.id }}" 
                                                   onchange="updateThemeStreams({{ theme.id }})">
                                            <label for="stream-{{ theme.id }}-{{ stream.id }}">{{ stream.stream_code }}</label>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- –ö–Ω–æ–ø–∫–∏ –¥—ñ–π -->
                            <div class="theme-actions">
                                <button type="button" class="action-btn edit-btn" onclick="editTheme({{ theme.id }})" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                                    <i class="icon">‚úèÔ∏è</i>
                                    –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                                </button>
                                {% if theme.is_active and not theme.is_deleted %}
                                    <button type="button" class="action-btn deactivate-btn" onclick="toggleThemeStatus({{ theme.id }}, false)" title="–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏">
                                        <i class="icon">‚è∏Ô∏è</i>
                                        –î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏
                                    </button>
                                {% else %}
                                    <button type="button" class="action-btn activate-btn" onclick="toggleThemeStatus({{ theme.id }}, true)" title="–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏">
                                        <i class="icon">‚ñ∂Ô∏è</i>
                                        –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏
                                    </button>
                                {% endif %}
                                <button type="button" class="action-btn delete-btn" onclick="deleteThemeWithValidation({{ theme.id }})" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                    <i class="icon">üóëÔ∏è</i>
                                    –í–∏–¥–∞–ª–∏—Ç–∏
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-themes-message">
                            <p>–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î —Ç–µ–º. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à—É —Ç–µ–º—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–Ω–æ–ø–∫–∏ –≤–∏—â–µ.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- –®–∞–±–ª–æ–Ω –¥–ª—è –Ω–æ–≤–æ—ó —Ç–µ–º–∏ -->
                <div id="new-theme-template" style="display: none;">
                    <div class="theme-card new-theme">
                        <div class="theme-title-container">
                            <input type="text" class="theme-title-input" placeholder="–ù–∞–∑–≤–∞ —Ç–µ–º–∏" maxlength="100">
                        </div>
                        
                        <div class="theme-status-container">
                            <div class="status-indicator active">
                                <span class="status-dot"></span>
                                <span class="status-text">–ê–∫—Ç–∏–≤–Ω–∞</span>
                            </div>
                            <div class="requests-count">
                                –ó–∞–ø–∏—Ç—ñ–≤: 0
                            </div>
                        </div>
                        
                        <div class="theme-description-container">
                            <textarea class="theme-description-input" placeholder="–û–ø–∏—Å —Ç–µ–º–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" rows="3"></textarea>
                        </div>
                        
                        <div class="theme-streams-container">
                            <label class="streams-label">–û–±–µ—Ä—ñ—Ç—å –ø–æ—Ç–æ–∫–∏:</label>
                            <div class="streams-list">
                                {% for stream in all_streams %}
                                <div class="stream-item">
                                    <input type="checkbox" id="new-stream-{{ stream.id }}" value="{{ stream.id }}">
                                    <label for="new-stream-{{ stream.id }}">{{ stream.stream_code }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="theme-actions">
                            <button type="button" class="action-btn save-btn" onclick="saveNewTheme(this)">
                                <i class="icon">üíæ</i>
                                –ó–±–µ—Ä–µ–≥—Ç–∏
                            </button>
                            <button type="button" class="action-btn cancel-btn" onclick="cancelNewTheme(this)">
                                <i class="icon">‚ùå</i>
                                –°–∫–∞—Å—É–≤–∞—Ç–∏
                            </button>
                        </div>
                    </div>
                    </div>
                  </div>
                </div>
            </div>
            
            <div class="form-buttons">
                <button type="submit" class="save-button">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <a href="{% url 'profile' %}" class="back-button">–ó–∞–≤–µ—Ä—à–∏—Ç–∏</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–∑—à–∏—Ä–µ–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ–º–∞–º–∏ ---

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è CSRF —Ç–æ–∫–µ–Ω—É
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –∫—Ä–∞—Å–∏–≤–∏—Ö toast –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
function showMessage(message, type = 'success') {
    // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ toast'–∏
    document.querySelectorAll('.toast-message').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-message toast-${type}`;
    
    // –Ü–∫–æ–Ω–∫–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ç–∏–ø—ñ–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    const icons = {
        'success': '‚úÖ',
        'error': '‚ùå',
        'info': '‚ÑπÔ∏è',
        'warning': '‚ö†Ô∏è'
    };
    
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-icon">${icons[type] || icons.info}</span>
            <span class="toast-text">${message}</span>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
        </div>
    `;
    
    // –î–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—ñ –ø—Ä—è–º–æ –≤ –µ–ª–µ–º–µ–Ω—Ç
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        background: ${type === 'error' ? '#fee' : type === 'warning' ? '#fef3cd' : type === 'info' ? '#d1ecf1' : '#d4edda'};
        border: 1px solid ${type === 'error' ? '#f5c6cb' : type === 'warning' ? '#faeeba' : type === 'info' ? '#bee5eb' : '#c3e6cb'};
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease-out;
        font-family: 'Inter', sans-serif;
    `;
    
    toast.querySelector('.toast-content').style.cssText = `
        display: flex;
        align-items: center;
        padding: 12px 16px;
        gap: 10px;
    `;
    
    toast.querySelector('.toast-icon').style.cssText = `
        font-size: 18px;
        flex-shrink: 0;
    `;
    
    toast.querySelector('.toast-text').style.cssText = `
        color: ${type === 'error' ? '#721c24' : type === 'warning' ? '#856404' : type === 'info' ? '#0c5460' : '#155724'};
        font-size: 14px;
        line-height: 1.4;
        flex-grow: 1;
    `;
    
    toast.querySelector('.toast-close').style.cssText = `
        background: none;
        border: none;
        font-size: 18px;
        color: #aaa;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    `;
    
    // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .toast-message.hiding {
            animation: slideOutRight 0.3s ease-in forwards;
        }
    `;
    
    if (!document.querySelector('#toast-styles')) {
        style.id = 'toast-styles';
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –∫—Ä–∞—Å–∏–≤–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
function showConfirmDialog(title, message, onConfirm, onCancel = null) {
    // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –¥—ñ–∞–ª–æ–≥–∏
    document.querySelectorAll('.confirm-dialog').forEach(dialog => dialog.remove());
    
    const dialog = document.createElement('div');
    dialog.className = 'confirm-dialog';
    
    dialog.innerHTML = `
        <div class="confirm-overlay" onclick="closeConfirmDialog()"></div>
        <div class="confirm-modal">
            <div class="confirm-header">
                <h3>${title}</h3>
            </div>
            <div class="confirm-body">
                <p>${message}</p>
            </div>
            <div class="confirm-footer">
                <button class="confirm-btn confirm-cancel" onclick="closeConfirmDialog()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="confirm-btn confirm-ok" onclick="confirmAction()">OK</button>
            </div>
        </div>
    `;
    
    // –î–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—ñ
    dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
    `;
    
    const overlay = dialog.querySelector('.confirm-overlay');
    overlay.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
    `;
    
    const modal = dialog.querySelector('.confirm-modal');
    modal.style.cssText = `
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        min-width: 400px;
        max-width: 500px;
        position: relative;
        animation: scaleIn 0.2s ease-out;
    `;
    
    const header = dialog.querySelector('.confirm-header');
    header.style.cssText = `
        padding: 20px 24px 16px;
        border-bottom: 1px solid #e5e7eb;
    `;
    
    const headerTitle = dialog.querySelector('.confirm-header h3');
    headerTitle.style.cssText = `
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    `;
    
    const body = dialog.querySelector('.confirm-body');
    body.style.cssText = `
        padding: 20px 24px;
    `;
    
    const bodyText = dialog.querySelector('.confirm-body p');
    bodyText.style.cssText = `
        margin: 0;
        font-size: 14px;
        line-height: 1.5;
        color: #4b5563;
    `;
    
    const footer = dialog.querySelector('.confirm-footer');
    footer.style.cssText = `
        padding: 16px 24px 20px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    `;
    
    const buttons = dialog.querySelectorAll('.confirm-btn');
    buttons.forEach(button => {
        button.style.cssText = `
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        `;
    });
    
    const cancelBtn = dialog.querySelector('.confirm-cancel');
    cancelBtn.style.cssText += `
        background: #f3f4f6;
        color: #374151;
        border-color: #d1d5db;
    `;
    
    const okBtn = dialog.querySelector('.confirm-ok');
    okBtn.style.cssText += `
        background: #dc2626;
        color: white;
        border-color: #dc2626;
    `;
    
    // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—ó
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .confirm-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .confirm-cancel:hover {
            background: #e5e7eb !important;
        }
        .confirm-ok:hover {
            background: #b91c1c !important;
        }
    `;
    
    if (!document.querySelector('#confirm-styles')) {
        style.id = 'confirm-styles';
        document.head.appendChild(style);
    }
    
    // –ó–±–µ—Ä–µ–≥—Ç–∏ callback —Ñ—É–Ω–∫—Ü—ñ—ó
    window.currentConfirmAction = onConfirm;
    window.currentCancelAction = onCancel;
    
    document.body.appendChild(dialog);
    
    // –§–æ–∫—É—Å –Ω–∞ OK –∫–Ω–æ–ø—Ü—ñ
    okBtn.focus();
}

// –ó–∞–∫—Ä–∏—Ç–∏ –¥—ñ–∞–ª–æ–≥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
function closeConfirmDialog() {
    const dialog = document.querySelector('.confirm-dialog');
    if (dialog) {
        if (window.currentCancelAction) {
            window.currentCancelAction();
        }
        dialog.style.animation = 'fadeOut 0.2s ease-in';
        setTimeout(() => dialog.remove(), 200);
    }
    window.currentConfirmAction = null;
    window.currentCancelAction = null;
}

// –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –¥—ñ—é
function confirmAction() {
    if (window.currentConfirmAction) {
        window.currentConfirmAction();
    }
    closeConfirmDialog();
}

// –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É —Ç–µ–º—É
function addNewTheme() {
    const template = document.getElementById('new-theme-template');
    const container = document.getElementById('themes-grid');
    const noThemes = container.querySelector('.no-themes-message');
    
    if (noThemes) {
        noThemes.remove();
    }
    
    const newTheme = template.innerHTML;
    container.insertAdjacentHTML('beforeend', newTheme);
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–∞–∑–≤–∏
    const newThemeElement = container.lastElementChild;
    const themeInput = newThemeElement.querySelector('.theme-title-input');
    themeInput.focus();
}

// –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–æ–≤—É —Ç–µ–º—É
async function saveNewTheme(button) {
    const themeCard = button.closest('.theme-card');
    const themeName = themeCard.querySelector('.theme-title-input').value.trim();
    const themeDescription = themeCard.querySelector('.theme-description-input').value.trim();
    
    if (!themeName) {
        showMessage('–ù–∞–∑–≤–∞ —Ç–µ–º–∏ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—å–æ—é', 'error');
        return;
    }
    
    // –í—ñ–¥–∫–ª—é—á–∏—Ç–∏ –∫–Ω–æ–ø–∫—É –ø—ñ–¥ —á–∞—Å –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
    button.disabled = true;
    button.innerHTML = '<i class="icon">‚è≥</i> –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
    
    // –û—Ç—Ä–∏–º–∞—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ –ø–æ—Ç–æ–∫–∏
    const selectedStreams = [];
    themeCard.querySelectorAll('.streams-list input[type="checkbox"]:checked').forEach(checkbox => {
        selectedStreams.push(parseInt(checkbox.value));
    });
    
    try {
        const requestData = {
            'theme': themeName,
            'description': themeDescription,
            'stream_ids': selectedStreams
        };
        
        const response = await fetch('/users/teacher-theme/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message || '–¢–µ–º—É —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!', 'success');
            
            // –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –∫–∞—Ä—Ç–∫—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ—ó —Ç–µ–º–∏
            const newCard = createThemeCard(
                data.theme.id,  // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ ID –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–µ—Ä–≤–µ—Ä–∞
                data.theme.theme,
                data.theme.description,
                data.theme.streams || [],
                data.theme.is_active
            );
            
            // –ó–∞–º—ñ–Ω–∏—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤—É –∫–∞—Ä—Ç–∫—É –Ω–∞ –ø–æ—Å—Ç—ñ–π–Ω—É
            const container = themeCard.parentNode;
            container.replaceChild(newCard, themeCard);
            
        } else {
            showMessage(data.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç–µ–º–∏', 'error');
            
            // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É
            button.disabled = false;
            button.innerHTML = '<i class="icon">üíæ</i> –ó–±–µ—Ä–µ–≥—Ç–∏';
        }
        
    } catch (error) {
        showMessage('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç–µ–º–∏: ' + error.message, 'error');
        
        // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É
        button.disabled = false;
        button.innerHTML = '<i class="icon">üíæ</i> –ó–±–µ—Ä–µ–≥—Ç–∏';
    }
}

// –°—Ç–≤–æ—Ä–∏—Ç–∏ HTML –¥–ª—è –∫–∞—Ä—Ç–∫–∏ —Ç–µ–º–∏
function createThemeCard(themeId, themeName, themeDescription, streamIds, isActive) {
    const card = document.createElement('div');
    card.className = 'theme-card';
    card.dataset.themeId = themeId;
    card.dataset.active = isActive ? 'true' : 'false';
    
    // –°—Ç–≤–æ—Ä–∏—Ç–∏ HTML –¥–ª—è –ø–æ—Ç–æ–∫—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ template
    let streamsHTML = '';
    
    // –ë–µ—Ä—î–º–æ –ø–æ—Ç–æ–∫–∏ –∑ —à–∞–±–ª–æ–Ω—É –Ω–æ–≤–æ—ó —Ç–µ–º–∏
    const templateStreams = document.querySelectorAll('#new-theme-template .stream-item');
    
    templateStreams.forEach(streamItem => {
        const checkbox = streamItem.querySelector('input[type="checkbox"]');
        const label = streamItem.querySelector('label');
        const streamId = parseInt(checkbox.value);
        const streamCode = label.textContent;  // –¢—É—Ç –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è stream_code
        const isChecked = streamIds.includes(streamId);
        
        streamsHTML += `
            <div class="stream-item">
                <input type="checkbox" id="stream-${themeId}-${streamId}" 
                       value="${streamId}" ${isChecked ? 'checked' : ''} 
                       onchange="updateThemeStreams(${themeId})">
                <label for="stream-${themeId}-${streamId}">${streamCode}</label>
            </div>
        `;
    });
    
    card.innerHTML = `
        <div class="theme-title-container">
            <h4 class="theme-title" title="${themeName}">${themeName}</h4>
        </div>
        
        <div class="theme-status-container">
            <div class="status-indicator ${isActive ? 'active' : 'inactive'}">
                <span class="status-dot"></span>
                <span class="status-text">${isActive ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}</span>
            </div>
            <div class="requests-count">
                –ó–∞–ø–∏—Ç—ñ–≤: 0
            </div>
        </div>
        
        ${themeDescription ? `<div class="theme-description">${themeDescription}</div>` : ''}
        
        <div class="theme-streams-container">
            <label class="streams-label">–ü–æ—Ç–æ–∫–∏:</label>
            <div class="streams-list" data-theme-id="${themeId}">
                ${streamsHTML}
            </div>
        </div>
        
        <div class="theme-actions">
            <button type="button" class="action-btn edit-btn" onclick="editTheme(${themeId})" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                <i class="icon">‚úèÔ∏è</i>
                –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
            </button>
            <button type="button" class="action-btn ${isActive ? 'deactivate-btn' : 'activate-btn'}" onclick="toggleThemeStatus(${themeId}, ${!isActive})" title="${isActive ? '–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏' : '–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏'}">
                <i class="icon">${isActive ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</i>
                ${isActive ? '–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏' : '–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏'}
            </button>
            <button type="button" class="action-btn delete-btn" onclick="deleteThemeWithValidation(${themeId})" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                <i class="icon">üóëÔ∏è</i>
                –í–∏–¥–∞–ª–∏—Ç–∏
            </button>
        </div>
    `;
    
    return card;
}

// –°–∫–∞—Å—É–≤–∞—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó —Ç–µ–º–∏
function cancelNewTheme(button) {
    const themeCard = button.closest('.theme-card');
    themeCard.remove();
    
    // –ü–æ–∫–∞–∑–∞—Ç–∏ "–Ω–µ–º–∞—î —Ç–µ–º" —è–∫—â–æ —Ü–µ –±—É–ª–∞ —î–¥–∏–Ω–∞ —Ç–µ–º–∞
    const container = document.getElementById('themes-grid');
    if (container.children.length === 0) {
        container.innerHTML = `
            <div class="no-themes-message">
                <p>–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î —Ç–µ–º. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à—É —Ç–µ–º—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–Ω–æ–ø–∫–∏ –≤–∏—â–µ.</p>
            </div>
        `;
    }
}

// –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–µ–º—É
function editTheme(themeId) {
    const themeCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    if (!themeCard) return;
    
    const titleContainer = themeCard.querySelector('.theme-title-container');
    const descriptionDiv = themeCard.querySelector('.theme-description');
    const actionsDiv = themeCard.querySelector('.theme-actions');
    
    // –ó–±–µ—Ä–µ–≥—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
    const originalTitle = themeCard.querySelector('.theme-title').textContent;
    const originalDescription = descriptionDiv ? descriptionDiv.textContent.trim() : '';
    const originalActions = actionsDiv.innerHTML;
    
    // –ü–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –ø–æ–ª–µ –≤–≤–µ–¥–µ–Ω–Ω—è
    titleContainer.innerHTML = `<input type="text" class="theme-title-input" value="${originalTitle}" maxlength="100">`;
    
    // –ü–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ –æ–ø–∏—Å –Ω–∞ textarea –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–ª–µ —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î
    if (descriptionDiv) {
        descriptionDiv.innerHTML = `<textarea class="theme-description-input" rows="3">${originalDescription}</textarea>`;
    } else {
        const descriptionContainer = document.createElement('div');
        descriptionContainer.className = 'theme-description-container';
        descriptionContainer.innerHTML = `<textarea class="theme-description-input" placeholder="–î–æ–¥–∞—Ç–∏ –æ–ø–∏—Å —Ç–µ–º–∏..." rows="3">${originalDescription}</textarea>`;
        themeCard.querySelector('.theme-status-container').parentNode.insertBefore(descriptionContainer, themeCard.querySelector('.theme-streams-container'));
    }
    
    // –ó–º—ñ–Ω–∏—Ç–∏ –∫–Ω–æ–ø–∫–∏
    actionsDiv.innerHTML = `
        <button type="button" class="action-btn save-btn" onclick="saveThemeChanges(${themeId})">
            <i class="icon">üíæ</i>
            –ó–±–µ—Ä–µ–≥—Ç–∏
        </button>
        <button type="button" class="action-btn cancel-btn" onclick="cancelThemeEdit(${themeId}, this)">
            <i class="icon">‚ùå</i>
            –°–∫–∞—Å—É–≤–∞—Ç–∏
        </button>
    `;
    
    // –ó–±–µ—Ä–µ–≥—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ
    themeCard.dataset.originalTitle = originalTitle;
    themeCard.dataset.originalDescription = originalDescription;
    themeCard.dataset.originalActions = originalActions;
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –Ω–∞–∑–≤–∏
    titleContainer.querySelector('.theme-title-input').focus();
}

// –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏ —Ç–µ–º–∏
function saveThemeChanges(themeId) {
    const card = document.querySelector(`[data-theme-id="${themeId}"]`);
    if (!card) return;
    
    const titleInput = card.querySelector('.theme-title-input');
    const descInput = card.querySelector('.theme-description-input');
    const saveBtn = card.querySelector('.save-btn');
    
    if (!titleInput) {
        showMessage('–ü–æ–º–∏–ª–∫–∞: –ø–æ–ª–µ –Ω–∞–∑–≤–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
        return;
    }
    
    const newTitle = titleInput.value.trim();
    const newDescription = descInput ? descInput.value.trim() : '';
    
    if (!newTitle) {
        showMessage('–ù–∞–∑–≤–∞ —Ç–µ–º–∏ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—å–æ—é', 'error');
        titleInput.focus();
        return;
    }
    
    // –ü–æ–∫–∞–∑—É—î–º–æ —Å—Ç–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    const originalBtnContent = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="icon">‚è≥</i> –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
    
    // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(`/users/teacher-theme/update/${themeId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            theme: newTitle,
            description: newDescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –°–ø–æ—á–∞—Ç–∫—É –≤–∏–¥–∞–ª–∏–º–æ –≤—Å—ñ —Ç–∏–º—á–∞—Å–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
            const descriptionContainer = card.querySelector('.theme-description-container');
            if (descriptionContainer) {
                descriptionContainer.remove();
            }
            
            // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
            const titleContainer = card.querySelector('.theme-title-container');
            titleContainer.innerHTML = `<h4 class="theme-title" title="${newTitle}">${newTitle}</h4>`;
            
            // –û–±—Ä–æ–±–∏—Ç–∏ –æ–ø–∏—Å
            let descriptionDiv = card.querySelector('.theme-description');
            
            if (newDescription && newDescription.trim()) {
                // –Ø–∫—â–æ —î –Ω–æ–≤–∏–π –æ–ø–∏—Å
                if (descriptionDiv) {
                    // –û–Ω–æ–≤–∏—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π
                    descriptionDiv.textContent = newDescription;
                } else {
                    // –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π div –¥–ª—è –æ–ø–∏—Å—É
                    descriptionDiv = document.createElement('div');
                    descriptionDiv.className = 'theme-description';
                    descriptionDiv.textContent = newDescription;
                    card.querySelector('.theme-status-container').parentNode.insertBefore(descriptionDiv, card.querySelector('.theme-streams-container'));
                }
            } else {
                // –Ø–∫—â–æ –æ–ø–∏—Å –ø–æ—Ä–æ–∂–Ω—ñ–π, –≤–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π div
                if (descriptionDiv) {
                    descriptionDiv.remove();
                }
            }
            
            // –¢–µ–ø–µ—Ä –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –∫–Ω–æ–ø–∫–∏ (–±–µ–∑ –≤–∏–∫–ª–∏–∫–∞exitEditMode)
            const actionsDiv = card.querySelector('.theme-actions');
            actionsDiv.innerHTML = card.dataset.originalActions;
            
            // –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤—ñ –¥–∞–Ω—ñ
            delete card.dataset.originalTitle;
            delete card.dataset.originalDescription;
            delete card.dataset.originalActions;
            
            showMessage(data.message || '–¢–µ–º—É —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        } else {
            showMessage(data.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Ç–µ–º–∏', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Ç–µ–º–∏', 'error');
    })
    .finally(() => {
        // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–∫–∏
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnContent;
        }
    });
}

// –°–∫–∞—Å—É–≤–∞—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–µ–º–∏
function cancelThemeEdit(themeId, button) {
    const themeCard = button.closest('.theme-card');
    if (!themeCard) return;
    
    const originalTitle = themeCard.dataset.originalTitle;
    const originalDescription = themeCard.dataset.originalDescription;
    
    // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const titleContainer = themeCard.querySelector('.theme-title-container');
    titleContainer.innerHTML = `<h4 class="theme-title" title="${originalTitle}">${originalTitle}</h4>`;
    
    // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –æ–ø–∏—Å
    const descriptionContainer = themeCard.querySelector('.theme-description-container');
    if (descriptionContainer) {
        descriptionContainer.remove();
    }
    
    let descriptionDiv = themeCard.querySelector('.theme-description');
    if (originalDescription && originalDescription.trim()) {
        if (!descriptionDiv) {
            descriptionDiv = document.createElement('div');
            descriptionDiv.className = 'theme-description';
            themeCard.querySelector('.theme-status-container').parentNode.insertBefore(descriptionDiv, themeCard.querySelector('.theme-streams-container'));
        }
        descriptionDiv.textContent = originalDescription;
    } else if (descriptionDiv) {
        descriptionDiv.remove();
    }
    
    exitEditMode(themeCard);
}

// –í–∏–π—Ç–∏ –∑ —Ä–µ–∂–∏–º—É —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
function exitEditMode(themeCard) {
    const actionsDiv = themeCard.querySelector('.theme-actions');
    
    // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –∫–Ω–æ–ø–∫–∏
    actionsDiv.innerHTML = themeCard.dataset.originalActions;
    
    // –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤—ñ –¥–∞–Ω—ñ
    delete themeCard.dataset.originalTitle;
    delete themeCard.dataset.originalDescription;
    delete themeCard.dataset.originalActions;
}

// –ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Å—Ç–∞—Ç—É—Å —Ç–µ–º–∏ (–∞–∫—Ç–∏–≤–Ω–∞/–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)
async function toggleThemeStatus(themeId, activate) {
    const themeCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    const actionButton = themeCard.querySelector(activate ? '.activate-btn' : '.deactivate-btn');
    
    // –ó–±–µ—Ä–µ–≥—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –≤–º—ñ—Å—Ç –∫–Ω–æ–ø–∫–∏
    const originalContent = actionButton.innerHTML;
    const originalDisabled = actionButton.disabled;
    
    // –ü–æ–∫–∞–∑–∞—Ç–∏ loading
    actionButton.disabled = true;
    actionButton.innerHTML = '<i class="icon">‚è≥</i> –û–±—Ä–æ–±–∫–∞...';
    
    try {
        const endpoint = activate ? 
            `/users/teacher-theme/activate/${themeId}/` : 
            `/users/teacher-theme/deactivate/${themeId}/`;
            
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message || `–¢–µ–º—É ${activate ? '–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ' : '–¥–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ'}!`, 'success');
            
            // –û–Ω–æ–≤–∏—Ç–∏ UI
            const statusIndicator = themeCard.querySelector('.status-indicator');
            const statusText = statusIndicator.querySelector('.status-text');
            
            if (activate) {
                statusIndicator.className = 'status-indicator active';
                statusText.textContent = '–ê–∫—Ç–∏–≤–Ω–∞';
                actionButton.onclick = () => toggleThemeStatus(themeId, false);
                actionButton.innerHTML = '<i class="icon">‚è∏Ô∏è</i> –î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏';
                actionButton.className = 'action-btn deactivate-btn';
                actionButton.title = '–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏';
            } else {
                statusIndicator.className = 'status-indicator inactive';
                statusText.textContent = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞';
                actionButton.onclick = () => toggleThemeStatus(themeId, true);
                actionButton.innerHTML = '<i class="icon">‚ñ∂Ô∏è</i> –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏';
                actionButton.className = 'action-btn activate-btn';
                actionButton.title = '–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏';
            }
            
            themeCard.dataset.active = activate ? 'true' : 'false';
            actionButton.disabled = false;
            
        } else {
            showMessage(data.message || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–∞—Ç—É—Å—É —Ç–µ–º–∏', 'error');
            
            // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É
            actionButton.disabled = originalDisabled;
            actionButton.innerHTML = originalContent;
        }
        
    } catch (error) {
        showMessage('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–∞—Ç—É—Å—É —Ç–µ–º–∏: ' + error.message, 'error');
        
        // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É
        actionButton.disabled = originalDisabled;
        actionButton.innerHTML = originalContent;
    }
}

// –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–º—É –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é
async function deleteThemeWithValidation(themeId) {
    const themeCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    const themeName = themeCard.querySelector('.theme-title').textContent;
    const requestsCountText = themeCard.querySelector('.requests-count').textContent;
    const requestsCount = parseInt(requestsCountText.replace(/[^0-9]/g, '')) || 0;
    
    if (requestsCount > 0) {
        showMessage(`–ù–µ–º–æ–∂–ª–∏–≤–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–º—É "${themeName}". –í–æ–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ ${requestsCount} –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–ø–∏—Ç–∞—Ö.`, 'error');
        return;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫—Ä–∞—Å–∏–≤–∏–π –¥—ñ–∞–ª–æ–≥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
    showConfirmDialog(
        '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è',
        `–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–º—É "${themeName}"? –¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏.`,
        async () => {
            // –§—É–Ω–∫—Ü—ñ—è —è–∫–∞ –≤–∏–∫–æ–Ω–∞—î—Ç—å—Å—è –ø—Ä–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—ñ
            const deleteButton = themeCard.querySelector('.delete-btn');
            const originalContent = deleteButton.innerHTML;
            const originalDisabled = deleteButton.disabled;
            
            // –ü–æ–∫–∞–∑–∞—Ç–∏ loading
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<i class="icon">‚è≥</i> –í–∏–¥–∞–ª–µ–Ω–Ω—è...';
            
            try {
                const response = await fetch(`/users/teacher-theme/delete/${themeId}/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRFToken()
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message || '–¢–µ–º—É —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ!', 'success');
                    
                    // –í–∏–¥–∞–ª–∏—Ç–∏ –∑ UI –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
                    themeCard.style.transition = 'all 0.3s ease-out';
                    themeCard.style.transform = 'scale(0.95)';
                    themeCard.style.opacity = '0';
                    
                    setTimeout(() => {
                        themeCard.remove();
                        
                        // –ü–æ–∫–∞–∑–∞—Ç–∏ "–Ω–µ–º–∞—î —Ç–µ–º" —è–∫—â–æ —Ü–µ –±—É–ª–∞ –æ—Å—Ç–∞–Ω–Ω—è —Ç–µ–º–∞
                        const container = document.getElementById('themes-grid');
                        if (container.children.length === 0) {
                            container.innerHTML = `
                                <div class="no-themes-message">
                                    <p>–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î —Ç–µ–º. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à—É —Ç–µ–º—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–Ω–æ–ø–∫–∏ –≤–∏—â–µ.</p>
                                </div>
                            `;
                        }
                    }, 300);
                    
                } else {
                    showMessage(data.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ç–µ–º–∏', 'error');
                    
                    // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É
                    deleteButton.disabled = originalDisabled;
                    deleteButton.innerHTML = originalContent;
                }
                
            } catch (error) {
                showMessage('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ç–µ–º–∏: ' + error.message, 'error');
                
                // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É
                deleteButton.disabled = originalDisabled;
                deleteButton.innerHTML = originalContent;
            }
        }
    );
}

// –û–Ω–æ–≤–∏—Ç–∏ –ø–æ—Ç–æ–∫–∏ –¥–ª—è —Ç–µ–º–∏
async function updateThemeStreams(themeId) {
    const themeCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    const selectedStreams = [];
    
    themeCard.querySelectorAll('.streams-list input[type="checkbox"]:checked').forEach(checkbox => {
        selectedStreams.push(parseInt(checkbox.value));
    });
    
    try {
        const response = await fetch(`/users/teacher-theme/attach-streams/${themeId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                'stream_ids': selectedStreams
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('–ü–æ—Ç–æ–∫–∏ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω—ñ!', 'success');
        } else {
            showMessage(data.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –ø–æ—Ç–æ–∫—ñ–≤', 'error');
        }
        
    } catch (error) {
        showMessage('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –ø–æ—Ç–æ–∫—ñ–≤: ' + error.message, 'error');
    }
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('teacherProfileForm');
    const profilePictureInput = document.getElementById('profile-picture-input');
    const profilePreview = document.getElementById('profile-preview');

    // Convert Django error messages to toast notifications on page load
    const djangoMessages = document.getElementById('django-messages');
    if (djangoMessages) {
        const errorMessages = djangoMessages.querySelectorAll('.message.error');
        if (errorMessages.length > 0) {
            djangoMessages.style.display = 'none';
            const errorTexts = Array.from(errorMessages).map(msg => msg.textContent.trim());
            let userMessage = errorTexts.length === 1 ? errorTexts[0] : `–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–ø—Ä–∞–≤—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ –ø–æ–º–∏–ª–∫–∏:\n${errorTexts.join('\n')}`;
            showMessage(userMessage, 'error');
        }
    }

    function clearErrors() {
        document.querySelectorAll('.error-message').forEach(error => {
            error.textContent = '';
        });
    }

    function displayErrors(errors) {
        clearErrors();
        let errorMessages = [];
        Object.keys(errors).forEach(field => {
            const errorElement = document.getElementById(`${field}-error`);
            const fieldErrors = Array.isArray(errors[field]) ? errors[field] : [errors[field]];
            if (errorElement) {
                errorElement.textContent = fieldErrors.join(' ');
            }
            const fieldName = getFieldDisplayName(field);
            fieldErrors.forEach(error => {
                errorMessages.push(`${fieldName}: ${error}`);
            });
        });
        if (errorMessages.length > 0) {
            let userMessage = errorMessages.length === 1 ? errorMessages[0] : `–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–ø—Ä–∞–≤—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ –ø–æ–º–∏–ª–∫–∏:\n${errorMessages.join('\n')}`;
            showMessage(userMessage, 'error');
        }
    }

    function getFieldDisplayName(fieldName) {
        const fieldNames = {
            'first_name': "–Ü–º'—è",
            'last_name': '–ü—Ä—ñ–∑–≤–∏—â–µ',
            'patronymic': '–ü–æ-–±–∞—Ç—å–∫–æ–≤—ñ',
            'department': '–ö–∞—Ñ–µ–¥—Ä–∞',
            'academic_level': '–ù–∞—É–∫–æ–≤–∏–π —Ä—ñ–≤–µ–Ω—å',
            'additional_email': '–î–æ–¥–∞—Ç–∫–æ–≤–∞ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ —Å–∫—Ä–∏–Ω—å–∫–∞',
            'phone_number': '–†–æ–±–æ—á–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É'
        };
        return fieldNames[fieldName] || fieldName;
    }

    function handleProfilePictureChange(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profilePreview.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    if (profilePictureInput) {
        profilePictureInput.addEventListener('change', handleProfilePictureChange);
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        clearErrors();

        const djangoMessages = document.getElementById('django-messages');
        if (djangoMessages) {
            djangoMessages.style.display = 'none';
        }
        
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message || '–ü—Ä–æ—Ñ—ñ–ª—å —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            } else {
                if (data.errors) {
                    displayErrors(data.errors);
                } else if (data.message) {
                    showMessage(data.message, 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—é. –ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.', 'error');
        });
    });
});
</script>
{% endblock %}