{% extends "profile/profile-page.html" %}
{% load static %}
{% load catalog_extras %}

{% block content %}
<div class="edit-profile-container">
    <div class="edit-profile-header">
        <div class="profile-image">
            <img src="{% get_profile_picture_url user_profile %}" alt="Фото профілю" id="profile-preview">
        </div>
        <div class="profile-title">
            <h1>{{ user.get_full_name }}</h1>
            <p class="email">{{ user.email }}</p>
        </div>
    </div>

    <h2 class="edit-title">Редагувати профіль</h2>

    {% if messages %}
    <div class="messages" id="django-messages">
        {% for message in messages %}
            <div class="message {{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="form-content">
        <form method="post" class="edit-form" id="teacherProfileForm" enctype="multipart/form-data">
            {% csrf_token %}
    
            <div class="form-sections teacher-sections">
                <!-- LEFT COLUMN: Особиста інформація + Місця -->
                <div>
                  <div class="personal-info">
                    <h3>Особиста інформація</h3>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="{{ form.first_name.id_for_label }}">Ім'я</label>
                        {{ form.first_name }}
                        <div class="error-message" id="first_name-error"></div>
                      </div>
                      <div class="form-group">
                        <label for="{{ form.patronymic.id_for_label }}">По-батькові</label>
                        {{ form.patronymic }}
                        <div class="error-message" id="patronymic-error"></div>
                      </div>
                    </div>
                    <div class="form-group full-width">
                      <label for="{{ form.last_name.id_for_label }}">Прізвище</label>
                      {{ form.last_name }}
                      <div class="error-message" id="last_name-error"></div>
                    </div>
                    <div class="form-group full-width">
                      <label for="{{ form.department.id_for_label }}">Кафедра</label>
                      {{ form.department }}
                      <div class="error-message" id="department-error"></div>
                    </div>
                    <div class="form-group full-width">
                      <label for="{{ form.academic_level.id_for_label }}">Науковий рівень</label>
                      {{ form.academic_level }}
                      <div class="error-message" id="academic_level-error"></div>
                    </div>
                  </div>
                  <!-- Місця -->
                  <!-- ЗАКОМЕНТОВАНО: функціонал зміни квот (буде відновлено пізніше)
                  <div class="quota-section">
                    <h3>Місця</h3>
                    {% for slot in slots %}
                    <div class="form-row slot-row">
                      <div class="form-group">
                        <label>Квота</label>
                        <input type="number" 
                               name="quota_{{ slot.stream_id.id }}" 
                               value="{{ slot.quota }}" 
                               min="0" 
                               class="quota-input"
                               data-stream="{{ slot.stream_id.id }}">
                      </div>
                      <div class="form-group">
                        <label>Потік</label>
                        <input type="text" 
                               value="{{ slot.stream_id.stream_code }}" 
                               readonly 
                               class="stream-input">
                      </div>
                    </div>
                    {% endfor %}
                    <button type="button" id="addStreamBtn" class="add-stream-btn">
                      <i class="fas fa-plus"></i> <span>Додати новий потік</span>
                    </button>
                  </div>

                   
                  <div id="streamModal" class="modal">
                    <div class="modal-content">
                      <span class="close-modal" onclick="closeStreamModal()">&times;</span>
                      <h3>Додати новий потік</h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label for="streamSelect">Виберіть потік:</label>
                          <select id="streamSelect" class="form-control">
                            {% for stream in available_streams %}
                            <option value="{{ stream.id }}">{{ stream.stream_code }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="form-group">
                          <label for="newQuota">Квота:</label>
                          <input type="number" id="newQuota" min="0" value="0" class="form-control">
                        </div>
                      </div>
                      <button type="button" onclick="saveNewStream()" class="btn btn-success">Зберегти</button>
                    </div>
                  </div>
                  -->
                </div>
                <!-- Модальне вікно для вибору потоку -->
                <!-- RIGHT COLUMN: Контакти + Теми -->
                <div>
                  <div class="contacts">
                    <h3>Контакти</h3>
                    <div class="form-group">
                      <label for="{{ form.additional_email.id_for_label }}">Додаткова електронна скринька</label>
                      {{ form.additional_email }}
                      <div class="error-message" id="additional_email-error"></div>
                    </div>
                    <div class="form-group phone-group">
                      <label for="{{ form.phone_number.id_for_label }}">Робочий номер телефону</label>
                      <div class="phone-input">
                        <span class="country-code">+380</span>
                        {{ form.phone_number }}
                      </div>
                      <div class="error-message" id="phone_number-error"></div>
                    </div>
                  </div>
                <!-- ТЕМИ -->
                  <div class="themes-section">
                    <h3>Управління темами робіт</h3>
                    
                    <!-- Кнопка додавання нової теми -->
                    <div class="add-theme-container">
                        <button type="button" class="add-theme-btn" onclick="addNewTheme()">
                            <i class="plus-icon">+</i>
                            Додати нову тему
                        </button>
                    </div>

                    <!-- Контейнер карток тем -->
                    <div id="themes-grid" class="themes-grid">
                        {% for theme in existing_themes %}
                        <div class="theme-card" data-theme-id="{{ theme.id }}" data-active="{{ theme.is_active|yesno:'true,false' }}">
                            <!-- Заголовок теми -->
                            <div class="theme-title-container">
                                <h4 class="theme-title" title="{{ theme.theme }}">{{ theme.theme }}</h4>
                            </div>
                            
                            <!-- Статус та кількість запитів -->
                            <div class="theme-status-container">
                                <div class="status-indicator {% if theme.is_active and not theme.is_deleted %}active{% else %}inactive{% endif %}">
                                    <span class="status-dot"></span>
                                    <span class="status-text">{% if theme.is_active and not theme.is_deleted %}Активна{% else %}Неактивна{% endif %}</span>
                                </div>
                                <div class="requests-count">
                                    Запитів: {{ theme.get_active_requests_count }}
                                </div>
                            </div>
                            
                            <!-- Опис теми -->
                            {% if theme.theme_description %}
                            <div class="theme-description">
                                {{ theme.theme_description|truncatechars:120 }}
                            </div>
                            {% endif %}
                            
                            <!-- Потоки -->
                            <div class="theme-streams-container">
                                <label class="streams-label">Потоки:</label>
                                <div class="streams-list" data-theme-id="{{ theme.id }}">
                                    {% for stream in theme.streams.all %}
                                        <div class="stream-item">
                                            <input type="checkbox" id="stream-{{ theme.id }}-{{ stream.id }}" 
                                                   value="{{ stream.id }}" checked 
                                                   onchange="updateThemeStreams({{ theme.id }})">
                                            <label for="stream-{{ theme.id }}-{{ stream.id }}">{{ stream.stream_code }}</label>
                                        </div>
                                    {% endfor %}
                                    {% for stream in all_streams %}
                                        {% if stream not in theme.streams.all %}
                                        <div class="stream-item">
                                            <input type="checkbox" id="stream-{{ theme.id }}-{{ stream.id }}" 
                                                   value="{{ stream.id }}" 
                                                   onchange="updateThemeStreams({{ theme.id }})">
                                            <label for="stream-{{ theme.id }}-{{ stream.id }}">{{ stream.stream_code }}</label>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Кнопки дій -->
                            <div class="theme-actions">
                                <button type="button" class="action-btn edit-btn" onclick="editTheme({{ theme.id }})" title="Редагувати">
                                    <i class="icon">✏️</i>
                                    Редагувати
                                </button>
                                {% if theme.is_active and not theme.is_deleted %}
                                    <button type="button" class="action-btn deactivate-btn" onclick="toggleThemeStatus({{ theme.id }}, false)" title="Деактивувати">
                                        <i class="icon">⏸️</i>
                                        Деактивувати
                                    </button>
                                {% else %}
                                    <button type="button" class="action-btn activate-btn" onclick="toggleThemeStatus({{ theme.id }}, true)" title="Активувати">
                                        <i class="icon">▶️</i>
                                        Активувати
                                    </button>
                                {% endif %}
                                <button type="button" class="action-btn delete-btn" onclick="deleteThemeWithValidation({{ theme.id }})" title="Видалити">
                                    <i class="icon">🗑️</i>
                                    Видалити
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-themes-message">
                            <p>У вас поки немає тем. Додайте першу тему за допомогою кнопки вище.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Шаблон для нової теми -->
                <div id="new-theme-template" style="display: none;">
                    <div class="theme-card new-theme">
                        <div class="theme-title-container">
                            <input type="text" class="theme-title-input" placeholder="Назва теми" maxlength="100">
                        </div>
                        
                        <div class="theme-status-container">
                            <div class="status-indicator active">
                                <span class="status-dot"></span>
                                <span class="status-text">Активна</span>
                            </div>
                            <div class="requests-count">
                                Запитів: 0
                            </div>
                        </div>
                        
                        <div class="theme-description-container">
                            <textarea class="theme-description-input" placeholder="Опис теми (необов'язково)" rows="3"></textarea>
                        </div>
                        
                        <div class="theme-streams-container">
                            <label class="streams-label">Оберіть потоки:</label>
                            <div class="streams-list">
                                {% for stream in all_streams %}
                                <div class="stream-item">
                                    <input type="checkbox" id="new-stream-{{ stream.id }}" value="{{ stream.id }}">
                                    <label for="new-stream-{{ stream.id }}">{{ stream.stream_code }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="theme-actions">
                            <button type="button" class="action-btn save-btn" onclick="saveNewTheme(this)">
                                <i class="icon">💾</i>
                                Зберегти
                            </button>
                            <button type="button" class="action-btn cancel-btn" onclick="cancelNewTheme(this)">
                                <i class="icon">❌</i>
                                Скасувати
                            </button>
                        </div>
                    </div>
                    </div>
                  </div>
                </div>
            </div>
            
            <div class="form-buttons">
                <button type="submit" class="save-button">Зберегти</button>
                <a href="{% url 'profile' %}" class="back-button">Завершити</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- Глобальні функції для розширеного управління темами ---

// Функція для отримання CSRF токену
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Функція для показу красивих toast повідомлень
function showMessage(message, type = 'success') {
    // Видаляємо старі toast'и
    document.querySelectorAll('.toast-message').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-message toast-${type}`;
    
    // Іконки для різних типів повідомлень
    const icons = {
        'success': '✅',
        'error': '❌',
        'info': 'ℹ️',
        'warning': '⚠️'
    };
    
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-icon">${icons[type] || icons.info}</span>
            <span class="toast-text">${message}</span>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
    `;
    
    // Додаємо стилі прямо в елемент
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        background: ${type === 'error' ? '#fee' : type === 'warning' ? '#fef3cd' : type === 'info' ? '#d1ecf1' : '#d4edda'};
        border: 1px solid ${type === 'error' ? '#f5c6cb' : type === 'warning' ? '#faeeba' : type === 'info' ? '#bee5eb' : '#c3e6cb'};
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease-out;
        font-family: 'Inter', sans-serif;
    `;
    
    toast.querySelector('.toast-content').style.cssText = `
        display: flex;
        align-items: center;
        padding: 12px 16px;
        gap: 10px;
    `;
    
    toast.querySelector('.toast-icon').style.cssText = `
        font-size: 18px;
        flex-shrink: 0;
    `;
    
    toast.querySelector('.toast-text').style.cssText = `
        color: ${type === 'error' ? '#721c24' : type === 'warning' ? '#856404' : type === 'info' ? '#0c5460' : '#155724'};
        font-size: 14px;
        line-height: 1.4;
        flex-grow: 1;
    `;
    
    toast.querySelector('.toast-close').style.cssText = `
        background: none;
        border: none;
        font-size: 18px;
        color: #aaa;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    `;
    
    // Додаємо анімацію
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .toast-message.hiding {
            animation: slideOutRight 0.3s ease-in forwards;
        }
    `;
    
    if (!document.querySelector('#toast-styles')) {
        style.id = 'toast-styles';
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    // Автоматично видалити через 5 секунд
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// Функція для показу красивого модального підтвердження
function showConfirmDialog(title, message, onConfirm, onCancel = null) {
    // Видаляємо старі діалоги
    document.querySelectorAll('.confirm-dialog').forEach(dialog => dialog.remove());
    
    const dialog = document.createElement('div');
    dialog.className = 'confirm-dialog';
    
    dialog.innerHTML = `
        <div class="confirm-overlay" onclick="closeConfirmDialog()"></div>
        <div class="confirm-modal">
            <div class="confirm-header">
                <h3>${title}</h3>
            </div>
            <div class="confirm-body">
                <p>${message}</p>
            </div>
            <div class="confirm-footer">
                <button class="confirm-btn confirm-cancel" onclick="closeConfirmDialog()">Скасувати</button>
                <button class="confirm-btn confirm-ok" onclick="confirmAction()">OK</button>
            </div>
        </div>
    `;
    
    // Додаємо стилі
    dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
    `;
    
    const overlay = dialog.querySelector('.confirm-overlay');
    overlay.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
    `;
    
    const modal = dialog.querySelector('.confirm-modal');
    modal.style.cssText = `
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        min-width: 400px;
        max-width: 500px;
        position: relative;
        animation: scaleIn 0.2s ease-out;
    `;
    
    const header = dialog.querySelector('.confirm-header');
    header.style.cssText = `
        padding: 20px 24px 16px;
        border-bottom: 1px solid #e5e7eb;
    `;
    
    const headerTitle = dialog.querySelector('.confirm-header h3');
    headerTitle.style.cssText = `
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    `;
    
    const body = dialog.querySelector('.confirm-body');
    body.style.cssText = `
        padding: 20px 24px;
    `;
    
    const bodyText = dialog.querySelector('.confirm-body p');
    bodyText.style.cssText = `
        margin: 0;
        font-size: 14px;
        line-height: 1.5;
        color: #4b5563;
    `;
    
    const footer = dialog.querySelector('.confirm-footer');
    footer.style.cssText = `
        padding: 16px 24px 20px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    `;
    
    const buttons = dialog.querySelectorAll('.confirm-btn');
    buttons.forEach(button => {
        button.style.cssText = `
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        `;
    });
    
    const cancelBtn = dialog.querySelector('.confirm-cancel');
    cancelBtn.style.cssText += `
        background: #f3f4f6;
        color: #374151;
        border-color: #d1d5db;
    `;
    
    const okBtn = dialog.querySelector('.confirm-ok');
    okBtn.style.cssText += `
        background: #dc2626;
        color: white;
        border-color: #dc2626;
    `;
    
    // Додаємо анімації
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .confirm-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .confirm-cancel:hover {
            background: #e5e7eb !important;
        }
        .confirm-ok:hover {
            background: #b91c1c !important;
        }
    `;
    
    if (!document.querySelector('#confirm-styles')) {
        style.id = 'confirm-styles';
        document.head.appendChild(style);
    }
    
    // Зберегти callback функції
    window.currentConfirmAction = onConfirm;
    window.currentCancelAction = onCancel;
    
    document.body.appendChild(dialog);
    
    // Фокус на OK кнопці
    okBtn.focus();
}

// Закрити діалог підтвердження
function closeConfirmDialog() {
    const dialog = document.querySelector('.confirm-dialog');
    if (dialog) {
        if (window.currentCancelAction) {
            window.currentCancelAction();
        }
        dialog.style.animation = 'fadeOut 0.2s ease-in';
        setTimeout(() => dialog.remove(), 200);
    }
    window.currentConfirmAction = null;
    window.currentCancelAction = null;
}

// Підтвердити дію
function confirmAction() {
    if (window.currentConfirmAction) {
        window.currentConfirmAction();
    }
    closeConfirmDialog();
}

// Додати нову тему
function addNewTheme() {
    const template = document.getElementById('new-theme-template');
    const container = document.getElementById('themes-grid');
    const noThemes = container.querySelector('.no-themes-message');
    
    if (noThemes) {
        noThemes.remove();
    }
    
    const newTheme = template.innerHTML;
    container.insertAdjacentHTML('beforeend', newTheme);
    
    // Фокус на поле введення назви
    const newThemeElement = container.lastElementChild;
    const themeInput = newThemeElement.querySelector('.theme-title-input');
    themeInput.focus();
}

// Зберегти нову тему
async function saveNewTheme(button) {
    const themeCard = button.closest('.theme-card');
    const themeName = themeCard.querySelector('.theme-title-input').value.trim();
    const themeDescription = themeCard.querySelector('.theme-description-input').value.trim();
    
    if (!themeName) {
        showMessage('Назва теми не може бути порожньою', 'error');
        return;
    }
    
    // Відключити кнопку під час збереження
    button.disabled = true;
    button.innerHTML = '<i class="icon">⏳</i> Збереження...';
    
    // Отримати вибрані потоки
    const selectedStreams = [];
    themeCard.querySelectorAll('.streams-list input[type="checkbox"]:checked').forEach(checkbox => {
        selectedStreams.push(parseInt(checkbox.value));
    });
    
    try {
        const requestData = {
            'theme': themeName,
            'description': themeDescription,
            'stream_ids': selectedStreams
        };
        
        const response = await fetch('/users/teacher-theme/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message || 'Тему успішно створено!', 'success');
            
            // Створити нову картку для збереженої теми
            const newCard = createThemeCard(
                data.theme.id,  // Використовуємо ID з відповіді сервера
                data.theme.theme,
                data.theme.description,
                data.theme.streams || [],
                data.theme.is_active
            );
            
            // Замінити тимчасову картку на постійну
            const container = themeCard.parentNode;
            container.replaceChild(newCard, themeCard);
            
        } else {
            showMessage(data.error || 'Помилка при створенні теми', 'error');
            
            // Відновити кнопку
            button.disabled = false;
            button.innerHTML = '<i class="icon">💾</i> Зберегти';
        }
        
    } catch (error) {
        showMessage('Помилка при створенні теми: ' + error.message, 'error');
        
        // Відновити кнопку
        button.disabled = false;
        button.innerHTML = '<i class="icon">💾</i> Зберегти';
    }
}

// Створити HTML для картки теми
function createThemeCard(themeId, themeName, themeDescription, streamIds, isActive) {
    const card = document.createElement('div');
    card.className = 'theme-card';
    card.dataset.themeId = themeId;
    card.dataset.active = isActive ? 'true' : 'false';
    
    // Створити HTML для потоків на основі template
    let streamsHTML = '';
    
    // Берємо потоки з шаблону нової теми
    const templateStreams = document.querySelectorAll('#new-theme-template .stream-item');
    
    templateStreams.forEach(streamItem => {
        const checkbox = streamItem.querySelector('input[type="checkbox"]');
        const label = streamItem.querySelector('label');
        const streamId = parseInt(checkbox.value);
        const streamCode = label.textContent;  // Тут вже використовується stream_code
        const isChecked = streamIds.includes(streamId);
        
        streamsHTML += `
            <div class="stream-item">
                <input type="checkbox" id="stream-${themeId}-${streamId}" 
                       value="${streamId}" ${isChecked ? 'checked' : ''} 
                       onchange="updateThemeStreams(${themeId})">
                <label for="stream-${themeId}-${streamId}">${streamCode}</label>
            </div>
        `;
    });
    
    card.innerHTML = `
        <div class="theme-title-container">
            <h4 class="theme-title" title="${themeName}">${themeName}</h4>
        </div>
        
        <div class="theme-status-container">
            <div class="status-indicator ${isActive ? 'active' : 'inactive'}">
                <span class="status-dot"></span>
                <span class="status-text">${isActive ? 'Активна' : 'Неактивна'}</span>
            </div>
            <div class="requests-count">
                Запитів: 0
            </div>
        </div>
        
        ${themeDescription ? `<div class="theme-description">${themeDescription}</div>` : ''}
        
        <div class="theme-streams-container">
            <label class="streams-label">Потоки:</label>
            <div class="streams-list" data-theme-id="${themeId}">
                ${streamsHTML}
            </div>
        </div>
        
        <div class="theme-actions">
            <button type="button" class="action-btn edit-btn" onclick="editTheme(${themeId})" title="Редагувати">
                <i class="icon">✏️</i>
                Редагувати
            </button>
            <button type="button" class="action-btn ${isActive ? 'deactivate-btn' : 'activate-btn'}" onclick="toggleThemeStatus(${themeId}, ${!isActive})" title="${isActive ? 'Деактивувати' : 'Активувати'}">
                <i class="icon">${isActive ? '⏸️' : '▶️'}</i>
                ${isActive ? 'Деактивувати' : 'Активувати'}
            </button>
            <button type="button" class="action-btn delete-btn" onclick="deleteThemeWithValidation(${themeId})" title="Видалити">
                <i class="icon">🗑️</i>
                Видалити
            </button>
        </div>
    `;
    
    return card;
}

// Скасувати створення нової теми
function cancelNewTheme(button) {
    const themeCard = button.closest('.theme-card');
    themeCard.remove();
    
    // Показати "немає тем" якщо це була єдина тема
    const container = document.getElementById('themes-grid');
    if (container.children.length === 0) {
        container.innerHTML = `
            <div class="no-themes-message">
                <p>У вас поки немає тем. Додайте першу тему за допомогою кнопки вище.</p>
            </div>
        `;
    }
}

// Редагувати тему
function editTheme(themeId) {
    const themeCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    if (!themeCard) return;
    
    const titleContainer = themeCard.querySelector('.theme-title-container');
    const descriptionDiv = themeCard.querySelector('.theme-description');
    const actionsDiv = themeCard.querySelector('.theme-actions');
    
    // Зберегти оригінальні значення
    const originalTitle = themeCard.querySelector('.theme-title').textContent;
    const originalDescription = descriptionDiv ? descriptionDiv.textContent.trim() : '';
    const originalActions = actionsDiv.innerHTML;
    
    // Перетворити заголовок на поле введення
    titleContainer.innerHTML = `<input type="text" class="theme-title-input" value="${originalTitle}" maxlength="100">`;
    
    // Перетворити опис на textarea або створити поле якщо його немає
    if (descriptionDiv) {
        descriptionDiv.innerHTML = `<textarea class="theme-description-input" rows="3">${originalDescription}</textarea>`;
    } else {
        const descriptionContainer = document.createElement('div');
        descriptionContainer.className = 'theme-description-container';
        descriptionContainer.innerHTML = `<textarea class="theme-description-input" placeholder="Додати опис теми..." rows="3">${originalDescription}</textarea>`;
        themeCard.querySelector('.theme-status-container').parentNode.insertBefore(descriptionContainer, themeCard.querySelector('.theme-streams-container'));
    }
    
    // Змінити кнопки
    actionsDiv.innerHTML = `
        <button type="button" class="action-btn save-btn" onclick="saveThemeChanges(${themeId})">
            <i class="icon">💾</i>
            Зберегти
        </button>
        <button type="button" class="action-btn cancel-btn" onclick="cancelThemeEdit(${themeId}, this)">
            <i class="icon">❌</i>
            Скасувати
        </button>
    `;
    
    // Зберегти оригінальні дані
    themeCard.dataset.originalTitle = originalTitle;
    themeCard.dataset.originalDescription = originalDescription;
    themeCard.dataset.originalActions = originalActions;
    
    // Фокус на поле назви
    titleContainer.querySelector('.theme-title-input').focus();
}

// Зберегти зміни теми
function saveThemeChanges(themeId) {
    const card = document.querySelector(`[data-theme-id="${themeId}"]`);
    if (!card) return;
    
    const titleInput = card.querySelector('.theme-title-input');
    const descInput = card.querySelector('.theme-description-input');
    const saveBtn = card.querySelector('.save-btn');
    
    if (!titleInput) {
        showMessage('Помилка: поле назви не знайдено', 'error');
        return;
    }
    
    const newTitle = titleInput.value.trim();
    const newDescription = descInput ? descInput.value.trim() : '';
    
    if (!newTitle) {
        showMessage('Назва теми не може бути порожньою', 'error');
        titleInput.focus();
        return;
    }
    
    // Показуємо стан завантаження
    const originalBtnContent = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="icon">⏳</i> Збереження...';
    
    // Відправляємо запит на сервер
    fetch(`/users/teacher-theme/update/${themeId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            theme: newTitle,
            description: newDescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Спочатку видалимо всі тимчасові елементи редагування
            const descriptionContainer = card.querySelector('.theme-description-container');
            if (descriptionContainer) {
                descriptionContainer.remove();
            }
            
            // Відновити заголовок до нормального стану
            const titleContainer = card.querySelector('.theme-title-container');
            titleContainer.innerHTML = `<h4 class="theme-title" title="${newTitle}">${newTitle}</h4>`;
            
            // Обробити опис
            let descriptionDiv = card.querySelector('.theme-description');
            
            if (newDescription && newDescription.trim()) {
                // Якщо є новий опис
                if (descriptionDiv) {
                    // Оновити існуючий
                    descriptionDiv.textContent = newDescription;
                } else {
                    // Створити новий div для опису
                    descriptionDiv = document.createElement('div');
                    descriptionDiv.className = 'theme-description';
                    descriptionDiv.textContent = newDescription;
                    card.querySelector('.theme-status-container').parentNode.insertBefore(descriptionDiv, card.querySelector('.theme-streams-container'));
                }
            } else {
                // Якщо опис порожній, видалити існуючий div
                if (descriptionDiv) {
                    descriptionDiv.remove();
                }
            }
            
            // Тепер відновити оригінальні кнопки (без викликаexitEditMode)
            const actionsDiv = card.querySelector('.theme-actions');
            actionsDiv.innerHTML = card.dataset.originalActions;
            
            // Очистити тимчасові дані
            delete card.dataset.originalTitle;
            delete card.dataset.originalDescription;
            delete card.dataset.originalActions;
            
            showMessage(data.message || 'Тему успішно оновлено', 'success');
        } else {
            showMessage(data.error || 'Помилка при оновленні теми', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Сталася помилка при оновленні теми', 'error');
    })
    .finally(() => {
        // Відновлюємо стан кнопки
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnContent;
        }
    });
}

// Скасувати редагування теми
function cancelThemeEdit(themeId, button) {
    const themeCard = button.closest('.theme-card');
    if (!themeCard) return;
    
    const originalTitle = themeCard.dataset.originalTitle;
    const originalDescription = themeCard.dataset.originalDescription;
    
    // Відновити оригінальний заголовок
    const titleContainer = themeCard.querySelector('.theme-title-container');
    titleContainer.innerHTML = `<h4 class="theme-title" title="${originalTitle}">${originalTitle}</h4>`;
    
    // Відновити оригінальний опис
    const descriptionContainer = themeCard.querySelector('.theme-description-container');
    if (descriptionContainer) {
        descriptionContainer.remove();
    }
    
    let descriptionDiv = themeCard.querySelector('.theme-description');
    if (originalDescription && originalDescription.trim()) {
        if (!descriptionDiv) {
            descriptionDiv = document.createElement('div');
            descriptionDiv.className = 'theme-description';
            themeCard.querySelector('.theme-status-container').parentNode.insertBefore(descriptionDiv, themeCard.querySelector('.theme-streams-container'));
        }
        descriptionDiv.textContent = originalDescription;
    } else if (descriptionDiv) {
        descriptionDiv.remove();
    }
    
    exitEditMode(themeCard);
}

// Вийти з режиму редагування
function exitEditMode(themeCard) {
    const actionsDiv = themeCard.querySelector('.theme-actions');
    
    // Відновити оригінальні кнопки
    actionsDiv.innerHTML = themeCard.dataset.originalActions;
    
    // Очистити тимчасові дані
    delete themeCard.dataset.originalTitle;
    delete themeCard.dataset.originalDescription;
    delete themeCard.dataset.originalActions;
}

// Перемкнути статус теми (активна/неактивна)
async function toggleThemeStatus(themeId, activate) {
    const themeCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    const actionButton = themeCard.querySelector(activate ? '.activate-btn' : '.deactivate-btn');
    
    // Зберегти оригінальний вміст кнопки
    const originalContent = actionButton.innerHTML;
    const originalDisabled = actionButton.disabled;
    
    // Показати loading
    actionButton.disabled = true;
    actionButton.innerHTML = '<i class="icon">⏳</i> Обробка...';
    
    try {
        const endpoint = activate ? 
            `/users/teacher-theme/activate/${themeId}/` : 
            `/users/teacher-theme/deactivate/${themeId}/`;
            
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message || `Тему ${activate ? 'активовано' : 'деактивовано'}!`, 'success');
            
            // Оновити UI
            const statusIndicator = themeCard.querySelector('.status-indicator');
            const statusText = statusIndicator.querySelector('.status-text');
            
            if (activate) {
                statusIndicator.className = 'status-indicator active';
                statusText.textContent = 'Активна';
                actionButton.onclick = () => toggleThemeStatus(themeId, false);
                actionButton.innerHTML = '<i class="icon">⏸️</i> Деактивувати';
                actionButton.className = 'action-btn deactivate-btn';
                actionButton.title = 'Деактивувати';
            } else {
                statusIndicator.className = 'status-indicator inactive';
                statusText.textContent = 'Неактивна';
                actionButton.onclick = () => toggleThemeStatus(themeId, true);
                actionButton.innerHTML = '<i class="icon">▶️</i> Активувати';
                actionButton.className = 'action-btn activate-btn';
                actionButton.title = 'Активувати';
            }
            
            themeCard.dataset.active = activate ? 'true' : 'false';
            actionButton.disabled = false;
            
        } else {
            showMessage(data.message || 'Помилка при зміні статусу теми', 'error');
            
            // Відновити кнопку
            actionButton.disabled = originalDisabled;
            actionButton.innerHTML = originalContent;
        }
        
    } catch (error) {
        showMessage('Помилка при зміні статусу теми: ' + error.message, 'error');
        
        // Відновити кнопку
        actionButton.disabled = originalDisabled;
        actionButton.innerHTML = originalContent;
    }
}

// Видалити тему з валідацією
async function deleteThemeWithValidation(themeId) {
    const themeCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    const themeName = themeCard.querySelector('.theme-title').textContent;
    const requestsCountText = themeCard.querySelector('.requests-count').textContent;
    const requestsCount = parseInt(requestsCountText.replace(/[^0-9]/g, '')) || 0;
    
    if (requestsCount > 0) {
        showMessage(`Неможливо видалити тему "${themeName}". Вона використовується в ${requestsCount} активних запитах.`, 'error');
        return;
    }
    
    // Показати красивий діалог підтвердження
    showConfirmDialog(
        'Підтвердження видалення',
        `Ви впевнені, що хочете видалити тему "${themeName}"? Цю дію неможливо відмінити.`,
        async () => {
            // Функція яка виконається при підтвердженні
            const deleteButton = themeCard.querySelector('.delete-btn');
            const originalContent = deleteButton.innerHTML;
            const originalDisabled = deleteButton.disabled;
            
            // Показати loading
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<i class="icon">⏳</i> Видалення...';
            
            try {
                const response = await fetch(`/users/teacher-theme/delete/${themeId}/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRFToken()
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message || 'Тему успішно видалено!', 'success');
                    
                    // Видалити з UI з анімацією
                    themeCard.style.transition = 'all 0.3s ease-out';
                    themeCard.style.transform = 'scale(0.95)';
                    themeCard.style.opacity = '0';
                    
                    setTimeout(() => {
                        themeCard.remove();
                        
                        // Показати "немає тем" якщо це була остання тема
                        const container = document.getElementById('themes-grid');
                        if (container.children.length === 0) {
                            container.innerHTML = `
                                <div class="no-themes-message">
                                    <p>У вас поки немає тем. Додайте першу тему за допомогою кнопки вище.</p>
                                </div>
                            `;
                        }
                    }, 300);
                    
                } else {
                    showMessage(data.error || 'Помилка при видаленні теми', 'error');
                    
                    // Відновити кнопку
                    deleteButton.disabled = originalDisabled;
                    deleteButton.innerHTML = originalContent;
                }
                
            } catch (error) {
                showMessage('Помилка при видаленні теми: ' + error.message, 'error');
                
                // Відновити кнопку
                deleteButton.disabled = originalDisabled;
                deleteButton.innerHTML = originalContent;
            }
        }
    );
}

// Оновити потоки для теми
async function updateThemeStreams(themeId) {
    const themeCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    const selectedStreams = [];
    
    themeCard.querySelectorAll('.streams-list input[type="checkbox"]:checked').forEach(checkbox => {
        selectedStreams.push(parseInt(checkbox.value));
    });
    
    try {
        const response = await fetch(`/users/teacher-theme/attach-streams/${themeId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                'stream_ids': selectedStreams
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('Потоки успішно оновлені!', 'success');
        } else {
            showMessage(data.error || 'Помилка при оновленні потоків', 'error');
        }
        
    } catch (error) {
        showMessage('Помилка при оновленні потоків: ' + error.message, 'error');
    }
}

// Ініціалізація при завантаженні сторінки
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('teacherProfileForm');
    const profilePictureInput = document.getElementById('profile-picture-input');
    const profilePreview = document.getElementById('profile-preview');

    // Convert Django error messages to toast notifications on page load
    const djangoMessages = document.getElementById('django-messages');
    if (djangoMessages) {
        const errorMessages = djangoMessages.querySelectorAll('.message.error');
        if (errorMessages.length > 0) {
            djangoMessages.style.display = 'none';
            const errorTexts = Array.from(errorMessages).map(msg => msg.textContent.trim());
            let userMessage = errorTexts.length === 1 ? errorTexts[0] : `Будь ласка, виправте наступні помилки:\n${errorTexts.join('\n')}`;
            showMessage(userMessage, 'error');
        }
    }

    function clearErrors() {
        document.querySelectorAll('.error-message').forEach(error => {
            error.textContent = '';
        });
    }

    function displayErrors(errors) {
        clearErrors();
        let errorMessages = [];
        Object.keys(errors).forEach(field => {
            const errorElement = document.getElementById(`${field}-error`);
            const fieldErrors = Array.isArray(errors[field]) ? errors[field] : [errors[field]];
            if (errorElement) {
                errorElement.textContent = fieldErrors.join(' ');
            }
            const fieldName = getFieldDisplayName(field);
            fieldErrors.forEach(error => {
                errorMessages.push(`${fieldName}: ${error}`);
            });
        });
        if (errorMessages.length > 0) {
            let userMessage = errorMessages.length === 1 ? errorMessages[0] : `Будь ласка, виправте наступні помилки:\n${errorMessages.join('\n')}`;
            showMessage(userMessage, 'error');
        }
    }

    function getFieldDisplayName(fieldName) {
        const fieldNames = {
            'first_name': "Ім'я",
            'last_name': 'Прізвище',
            'patronymic': 'По-батькові',
            'department': 'Кафедра',
            'academic_level': 'Науковий рівень',
            'additional_email': 'Додаткова електронна скринька',
            'phone_number': 'Робочий номер телефону'
        };
        return fieldNames[fieldName] || fieldName;
    }

    function handleProfilePictureChange(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profilePreview.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    if (profilePictureInput) {
        profilePictureInput.addEventListener('change', handleProfilePictureChange);
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        clearErrors();

        const djangoMessages = document.getElementById('django-messages');
        if (djangoMessages) {
            djangoMessages.style.display = 'none';
        }
        
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message || 'Профіль успішно оновлено', 'success');
            } else {
                if (data.errors) {
                    displayErrors(data.errors);
                } else if (data.message) {
                    showMessage(data.message, 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Помилка при збереженні профілю. Будь ласка, спробуйте ще раз.', 'error');
        });
    });
});
</script>
{% endblock %}